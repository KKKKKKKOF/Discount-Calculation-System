<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è´·æ¬¾ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2em;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--gray);
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow-lg);
        }

        .card-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-group.hidden {
            display: none;
        }

        .form-help {
            font-size: 0.85em;
            color: var(--gray);
            margin-top: 5px;
        }

        .switch-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .info-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }

        .info-display .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .info-display .value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 5px;
        }

        .info-display-small {
            font-size: 0.85em;
            margin-top: 8px;
            opacity: 0.95;
        }

        .calendar {
            overflow-x: auto;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .calendar-nav h3 {
            font-size: 1.3em;
        }

        .calendar-nav-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .calendar-nav-btns button {
            padding: 8px 16px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .calendar-nav-btns button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .calendar-nav-btns button.btn-mark-paid {
            background: var(--success);
        }

        .calendar-nav-btns button.btn-mark-paid:hover {
            background: #059669;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            min-width: 600px;
        }

        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
            color: var(--dark);
        }

        .calendar-day {
            min-height: 100px;
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 8px;
            background: white;
            transition: all 0.3s;
        }

        .calendar-day:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .payment-item {
            color: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 0.75em;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .payment-item.paid {
            background: linear-gradient(135deg, #9ca3af, #6b7280) !important;
            opacity: 0.7;
        }

        .payment-item.paid .platform,
        .payment-item.paid .amount {
            text-decoration: line-through;
        }

        .payment-item .platform {
            font-weight: bold;
        }

        .payment-item .amount {
            font-size: 1.1em;
        }

        .payment-status {
            font-size: 0.8em;
            margin-top: 2px;
            opacity: 0.9;
        }

        .loans-list {
            margin-top: 20px;
        }

        .loan-item {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .loan-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .loan-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .loan-item-platform {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loan-color-badge {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            display: inline-block;
        }

        .loan-item-amount {
            font-weight: bold;
            color: var(--danger);
        }

        .loan-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9em;
            color: var(--gray);
        }

        .loan-item-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        .stat-card.secondary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .calendar-grid {
                min-width: auto;
                gap: 5px;
            }

            .calendar-day {
                min-height: 80px;
                padding: 5px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 12px;
            }

            .calendar-nav-btns button {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 1.5em;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            background: var(--primary);
            color: white;
        }

        .date-range-picker {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-range-picker input {
            flex: 1;
            min-width: 150px;
        }

        /* åŠ¨ç”» */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: slideIn 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ’° æ™ºèƒ½è´·æ¬¾ç®¡ç†ç³»ç»Ÿ</h1>
            <div class="header-actions">
                <button class="btn btn-success" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                <button class="btn btn-warning" onclick="importData()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">
            </div>
        </div>

        <!-- å€ºåŠ¡æ€»è§ˆ -->
        <div class="card">
            <h2 class="card-title">ğŸ“Š å€ºåŠ¡æ€»è§ˆ</h2>
            <div class="overview-grid">
                <div class="stat-card danger">
                    <div class="stat-label">å‰©ä½™æœ¬é‡‘æ€»é¢</div>
                    <div class="stat-value">Â¥<span id="totalDebt">0</span></div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">å‰©ä½™åˆ©æ¯æ€»é¢</div>
                    <div class="stat-value">Â¥<span id="remainingInterest">0</span></div>
                </div>
                <div class="stat-card secondary">
                    <div class="stat-label">æœ¬æœˆåº”è¿˜</div>
                    <div class="stat-value">Â¥<span id="monthlyPayment">0</span></div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">è´·æ¬¾ç¬”æ•°</div>
                    <div class="stat-value"><span id="loanCount">0</span> ç¬”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡åˆ©ç‡</div>
                    <div class="stat-value"><span id="avgRate">0</span>%</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">å·²è¿˜æœ¬é‡‘</div>
                    <div class="stat-value">Â¥<span id="paidPrincipal">0</span></div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">å·²ä»˜åˆ©æ¯</div>
                    <div class="stat-value">Â¥<span id="paidInterest">0</span></div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-label">ç´¯è®¡è¿˜æ¬¾æ€»é¢</div>
                    <div class="stat-value">Â¥<span id="totalPaid">0</span></div>
                </div>
            </div>

            <!-- æ—¶é—´æ®µè®¡ç®— -->
            <h3 style="margin-top: 20px; margin-bottom: 15px;">ğŸ“… æ—¶é—´æ®µè¿˜æ¬¾è®¡ç®—</h3>
            <div class="date-range-picker">
                <input type="date" id="startDate" class="form-group">
                <input type="date" id="endDate" class="form-group">
                <button class="btn btn-primary" onclick="calculateRange()">è®¡ç®—</button>
            </div>
            <div class="info-display" id="rangeResult" style="display: none;">
                <div class="label">è¯¥æ—¶é—´æ®µæ€»è¿˜æ¬¾é‡‘é¢</div>
                <div class="value">Â¥<span id="rangeAmount">0</span></div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒº -->
        <div class="main-grid">
            <!-- å·¦ä¾§ï¼šè´·æ¬¾è¡¨å• -->
            <div class="card">
                <h2 class="card-title">â• æ·»åŠ è´·æ¬¾</h2>
                <form id="loanForm" onsubmit="addLoan(event)">
                    <div class="form-group">
                        <label>è´·æ¬¾å¹³å° *</label>
                        <input type="text" id="platform" required placeholder="å¦‚ï¼šXXé“¶è¡Œ">
                    </div>

                    <div class="form-group">
                        <label>è´·æ¬¾é‡‘é¢ (å…ƒ) *</label>
                        <input type="number" id="amount" required placeholder="10000" step="0.01" min="0">
                    </div>

                    <div class="form-group">
                        <label>å¹´åˆ©ç‡ (%) *</label>
                        <input type="number" id="rate" required placeholder="4.5" step="0.01" min="0">
                    </div>

                    <div class="form-group">
                        <label>è´·æ¬¾æœŸæ•° (æœˆ) *</label>
                        <input type="number" id="term" required placeholder="12" min="1">
                    </div>

                    <div class="form-group">
                        <label>è¿˜æ¬¾æ–¹å¼ *</label>
                        <select id="repaymentType" onchange="handleRepaymentTypeChange()">
                            <option value="equalPrincipalInterest">ç­‰é¢æœ¬æ¯</option>
                            <option value="equalPrincipal">ç­‰é¢æœ¬é‡‘</option>
                            <option value="termLoan">å®šæœŸè´·æ¬¾ï¼ˆåˆ°æœŸä¸€æ¬¡æ€§è¿˜æœ¬ä»˜æ¯ï¼‰</option>
                            <option value="partialTermLoan">éƒ¨åˆ†å®šæœŸè´·æ¬¾ï¼ˆæ¯æœˆè¿˜åˆ©æ¯+éƒ¨åˆ†æœ¬é‡‘ï¼‰</option>
                        </select>
                    </div>

                    <div class="form-group hidden" id="principalRatioGroup">
                        <label>æ¯æœˆå½’è¿˜æœ¬é‡‘æ¯”ä¾‹ (%) *</label>
                        <input type="number" id="principalRatio" placeholder="50" step="0.01" min="0" max="100">
                        <div class="form-help">è®¾ç½®æ¯æœˆå½’è¿˜çš„æœ¬é‡‘å æ€»æœ¬é‡‘çš„ç™¾åˆ†æ¯”ï¼Œå‰©ä½™æœ¬é‡‘å°†åœ¨åˆ°æœŸæ—¶ä¸€æ¬¡æ€§å½’è¿˜</div>
                    </div>

                    <div class="form-group">
                        <label>é¦–æ¬¡è¿˜æ¬¾æ—¥æœŸ *</label>
                        <input type="date" id="firstPaymentDate" required>
                    </div>

                    <div class="form-group" id="paymentDayGroup">
                        <label>æ¯æœˆè¿˜æ¬¾æ—¥</label>
                        <input type="number" id="paymentDay" placeholder="1-31" min="1" max="31">
                    </div>

                    <div class="form-group" id="lastDayGroup">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="lastDayOfMonth" onchange="toggleLastDay()">
                            æ¯æœˆæœ€åä¸€å¤©è¿˜æ¬¾
                        </label>
                    </div>

                    <div class="info-display" id="calculatedPayment" style="display: none;">
                        <div class="label">è¿˜æ¬¾ä¿¡æ¯é¢„è§ˆ</div>
                        <div class="value">Â¥<span id="monthlyAmount">0</span></div>
                        <div class="info-display-small" id="paymentDetail"></div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                        âœ… æ·»åŠ è´·æ¬¾
                    </button>
                </form>

                <!-- è´·æ¬¾åˆ—è¡¨ -->
                <div class="loans-list">
                    <h3 style="margin: 20px 0 15px 0;">ğŸ“‹ æˆ‘çš„è´·æ¬¾</h3>
                    <div id="loansList"></div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ—¥å† -->
            <div class="card">
                <h2 class="card-title">ğŸ“… è¿˜æ¬¾æ—¥å†</h2>
                <div class="calendar">
                    <div class="calendar-nav">
                        <div class="calendar-nav-btns">
                            <button onclick="previousMonth()">â† ä¸Šæœˆ</button>
                            <button onclick="nextMonth()">ä¸‹æœˆ â†’</button>
                            <button onclick="goToToday()">ä»Šå¤©</button>
                            <button class="btn-mark-paid" onclick="markAllHistoricalPaymentsAsPaid()">âœ“ ä¸€é”®æ ‡è®°å†å²å·²è¿˜</button>
                        </div>
                        <h3 id="currentMonth"></h3>
                    </div>
                    <div class="calendar-grid" id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è´·æ¬¾æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç¼–è¾‘è´·æ¬¾</h2>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <form id="editLoanForm" onsubmit="updateLoan(event)">
                <input type="hidden" id="editLoanId">
                
                <div class="form-group">
                    <label>è´·æ¬¾å¹³å°</label>
                    <input type="text" id="editPlatform" required>
                </div>

                <div class="form-group">
                    <label>è´·æ¬¾é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="editAmount" required step="0.01">
                </div>

                <div class="form-group">
                    <label>å¹´åˆ©ç‡ (%)</label>
                    <input type="number" id="editRate" required step="0.01">
                </div>

                <div class="form-group">
                    <label>è´·æ¬¾æœŸæ•° (æœˆ)</label>
                    <input type="number" id="editTerm" required min="1">
                </div>

                <div class="form-group">
                    <label>è¿˜æ¬¾æ–¹å¼</label>
                    <select id="editRepaymentType" onchange="handleEditRepaymentTypeChange()">
                        <option value="equalPrincipalInterest">ç­‰é¢æœ¬æ¯</option>
                        <option value="equalPrincipal">ç­‰é¢æœ¬é‡‘</option>
                        <option value="termLoan">å®šæœŸè´·æ¬¾ï¼ˆåˆ°æœŸä¸€æ¬¡æ€§è¿˜æœ¬ä»˜æ¯ï¼‰</option>
                        <option value="partialTermLoan">éƒ¨åˆ†å®šæœŸè´·æ¬¾ï¼ˆæ¯æœˆè¿˜åˆ©æ¯+éƒ¨åˆ†æœ¬é‡‘ï¼‰</option>
                    </select>
                </div>

                <div class="form-group hidden" id="editPrincipalRatioGroup">
                    <label>æ¯æœˆå½’è¿˜æœ¬é‡‘æ¯”ä¾‹ (%)</label>
                    <input type="number" id="editPrincipalRatio" step="0.01" min="0" max="100">
                    <div class="form-help">è®¾ç½®æ¯æœˆå½’è¿˜çš„æœ¬é‡‘å æ€»æœ¬é‡‘çš„ç™¾åˆ†æ¯”</div>
                </div>

                <div class="form-group">
                    <label>é¦–æ¬¡è¿˜æ¬¾æ—¥æœŸ</label>
                    <input type="date" id="editFirstPaymentDate" required>
                </div>

                <div class="form-group" id="editPaymentDayGroup">
                    <label>æ¯æœˆè¿˜æ¬¾æ—¥</label>
                    <input type="number" id="editPaymentDay" min="1" max="31">
                </div>

                <div class="form-group" id="editLastDayGroup">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="editLastDayOfMonth">
                        æ¯æœˆæœ€åä¸€å¤©è¿˜æ¬¾
                    </label>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let loans = [];
        let currentDate = new Date();

        // ä¸ºä¸åŒè´·æ¬¾åˆ†é…çš„é¢œè‰²
        const loanColors = [
            'linear-gradient(135deg, #ef4444, #dc2626)',
            'linear-gradient(135deg, #f59e0b, #d97706)',
            'linear-gradient(135deg, #10b981, #059669)',
            'linear-gradient(135deg, #3b82f6, #2563eb)',
            'linear-gradient(135deg, #8b5cf6, #7c3aed)',
            'linear-gradient(135deg, #ec4899, #db2777)',
            'linear-gradient(135deg, #06b6d4, #0891b2)',
            'linear-gradient(135deg, #f97316, #ea580c)',
            'linear-gradient(135deg, #14b8a6, #0d9488)',
            'linear-gradient(135deg, #a855f7, #9333ea)'
        ];

        // è·å–è´·æ¬¾çš„é¢œè‰²
        function getLoanColor(loanId) {
            const index = loans.findIndex(l => l.id === loanId);
            return loanColors[index % loanColors.length];
        }

        // è·å–è´·æ¬¾çš„çº¯è‰²ï¼ˆç”¨äºè‰²å—æ˜¾ç¤ºï¼‰
        function getLoanSolidColor(loanId) {
            const colors = [
                '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6',
                '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#a855f7'
            ];
            const index = loans.findIndex(l => l.id === loanId);
            return colors[index % colors.length];
        }

        // è¿˜æ¬¾æ–¹å¼ç±»å‹å˜åŒ–å¤„ç†
        function handleRepaymentTypeChange() {
            const type = document.getElementById('repaymentType').value;
            const principalRatioGroup = document.getElementById('principalRatioGroup');
            const paymentDayGroup = document.getElementById('paymentDayGroup');
            const lastDayGroup = document.getElementById('lastDayGroup');
            
            if (type === 'partialTermLoan') {
                principalRatioGroup.classList.remove('hidden');
                document.getElementById('principalRatio').required = true;
            } else {
                principalRatioGroup.classList.add('hidden');
                document.getElementById('principalRatio').required = false;
            }

            // å®šæœŸè´·æ¬¾ä¸éœ€è¦æ¯æœˆè¿˜æ¬¾æ—¥è®¾ç½®
            if (type === 'termLoan') {
                paymentDayGroup.classList.add('hidden');
                lastDayGroup.classList.add('hidden');
            } else {
                paymentDayGroup.classList.remove('hidden');
                lastDayGroup.classList.remove('hidden');
            }

            calculateMonthlyPayment();
        }

        // ç¼–è¾‘æ¨¡æ€æ¡†çš„è¿˜æ¬¾æ–¹å¼å˜åŒ–å¤„ç†
        function handleEditRepaymentTypeChange() {
            const type = document.getElementById('editRepaymentType').value;
            const editPrincipalRatioGroup = document.getElementById('editPrincipalRatioGroup');
            const editPaymentDayGroup = document.getElementById('editPaymentDayGroup');
            const editLastDayGroup = document.getElementById('editLastDayGroup');
            
            if (type === 'partialTermLoan') {
                editPrincipalRatioGroup.classList.remove('hidden');
            } else {
                editPrincipalRatioGroup.classList.add('hidden');
            }

            if (type === 'termLoan') {
                editPaymentDayGroup.classList.add('hidden');
                editLastDayGroup.classList.add('hidden');
            } else {
                editPaymentDayGroup.classList.remove('hidden');
                editLastDayGroup.classList.remove('hidden');
            }
        }

        // ä¸€é”®æ ‡è®°å†å²è¿˜æ¬¾ä¸ºå·²è¿˜
        function markAllHistoricalPaymentsAsPaid() {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            // å…ˆç»Ÿè®¡æœ‰å¤šå°‘æœŸéœ€è¦æ ‡è®°
            let toMarkCount = 0;
            
            loans.forEach(loan => {
                const schedule = calculatePaymentSchedule(loan);
                schedule.forEach(payment => {
                    const paymentDate = new Date(payment.date);
                    paymentDate.setHours(0, 0, 0, 0);
                    const isPaid = isPaymentPaid(loan.id, payment.date);
                    
                    if (paymentDate < now && !isPaid) {
                        toMarkCount++;
                    }
                });
            });
            
            if (toMarkCount === 0) {
                alert('â„¹ï¸ æ²¡æœ‰éœ€è¦æ ‡è®°çš„å†å²è¿˜æ¬¾ã€‚æ‰€æœ‰å†å²è¿˜æ¬¾éƒ½å·²æ ‡è®°ä¸ºå·²è¿˜ï¼');
                return;
            }
            
            if (!confirm(`å‘ç° ${toMarkCount} æœŸå†å²è¿˜æ¬¾å°šæœªæ ‡è®°ä¸ºå·²è¿˜ã€‚\n\nç¡®å®šè¦å°†è¿™äº›å†å²è¿˜æ¬¾å…¨éƒ¨æ ‡è®°ä¸ºå·²è¿˜å—ï¼Ÿ`)) {
                return;
            }
            
            // æ‰§è¡Œæ ‡è®°
            let markedCount = 0;
            
            loans.forEach(loan => {
                const schedule = calculatePaymentSchedule(loan);
                
                if (!loan.paidPayments) {
                    loan.paidPayments = {};
                }
                
                schedule.forEach(payment => {
                    const paymentDate = new Date(payment.date);
                    paymentDate.setHours(0, 0, 0, 0);
                    const isPaid = loan.paidPayments[payment.date];
                    
                    if (paymentDate < now && !isPaid) {
                        loan.paidPayments[payment.date] = true;
                        markedCount++;
                    }
                });
            });
            
            saveData();
            renderCalendar();
            renderLoansList();
            updateOverview();
            alert(`âœ… æˆåŠŸæ ‡è®° ${markedCount} æœŸå†å²è¿˜æ¬¾ä¸ºå·²è¿˜ï¼`);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderCalendar();
            renderLoansList();
            updateOverview();
            
            // ç›‘å¬è¡¨å•è¾“å…¥ï¼Œå®æ—¶è®¡ç®—
            ['amount', 'rate', 'term', 'repaymentType', 'principalRatio'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateMonthlyPayment);
                }
            });

            // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ¬æœˆï¼‰
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            document.getElementById('startDate').valueAsDate = firstDay;
            document.getElementById('endDate').valueAsDate = lastDay;
        });

        // åˆ‡æ¢æœ€åä¸€å¤©é€‰é¡¹
        function toggleLastDay() {
            const lastDayCheckbox = document.getElementById('lastDayOfMonth');
            const paymentDayInput = document.getElementById('paymentDay');
            paymentDayInput.disabled = lastDayCheckbox.checked;
            if (lastDayCheckbox.checked) {
                paymentDayInput.value = '';
            }
        }

        // è®¡ç®—æ¯æœˆè¿˜æ¬¾é‡‘é¢
        function calculateMonthlyPayment() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const rate = parseFloat(document.getElementById('rate').value) || 0;
            const term = parseInt(document.getElementById('term').value) || 0;
            const type = document.getElementById('repaymentType').value;
            const principalRatio = parseFloat(document.getElementById('principalRatio').value) || 0;

            if (amount > 0 && rate >= 0 && term > 0) {
                const monthlyRate = rate / 100 / 12;
                let monthlyPayment = 0;
                let detailText = '';

                if (type === 'equalPrincipalInterest') {
                    // ç­‰é¢æœ¬æ¯
                    if (monthlyRate === 0) {
                        monthlyPayment = amount / term;
                    } else {
                        monthlyPayment = amount * monthlyRate * Math.pow(1 + monthlyRate, term) / 
                                        (Math.pow(1 + monthlyRate, term) - 1);
                    }
                    detailText = 'æ¯æœˆè¿˜æ¬¾';
                } else if (type === 'equalPrincipal') {
                    // ç­‰é¢æœ¬é‡‘ï¼ˆé¦–æœˆï¼‰
                    const monthlyPrincipal = amount / term;
                    const firstMonthInterest = amount * monthlyRate;
                    monthlyPayment = monthlyPrincipal + firstMonthInterest;
                    detailText = 'é¦–æœˆè¿˜æ¬¾ï¼ˆé€æœˆé€’å‡ï¼‰';
                } else if (type === 'termLoan') {
                    // å®šæœŸè´·æ¬¾
                    const totalInterest = amount * (rate / 100) * (term / 12);
                    monthlyPayment = amount + totalInterest;
                    detailText = `åˆ°æœŸä¸€æ¬¡æ€§è¿˜æ¬¾ï¼ˆæœ¬é‡‘: Â¥${amount.toFixed(2)} + åˆ©æ¯: Â¥${totalInterest.toFixed(2)}ï¼‰`;
                } else if (type === 'partialTermLoan') {
                    // éƒ¨åˆ†å®šæœŸè´·æ¬¾
                    if (principalRatio > 0 && principalRatio <= 100) {
                        const monthlyPrincipalTotal = amount * (principalRatio / 100);
                        const monthlyPrincipal = monthlyPrincipalTotal / term;
                        const firstMonthInterest = amount * monthlyRate;
                        monthlyPayment = monthlyPrincipal + firstMonthInterest;
                        
                        const remainingPrincipal = amount * (1 - principalRatio / 100);
                        detailText = `æ¯æœˆçº¦: Â¥${monthlyPayment.toFixed(2)}ï¼ˆé¦–æœˆå‚è€ƒï¼‰ï¼Œåˆ°æœŸè¿˜å‰©ä½™æœ¬é‡‘: Â¥${remainingPrincipal.toFixed(2)}`;
                    } else {
                        detailText = 'è¯·è®¾ç½®æ¯æœˆå½’è¿˜æœ¬é‡‘æ¯”ä¾‹';
                    }
                }

                document.getElementById('monthlyAmount').textContent = monthlyPayment.toFixed(2);
                document.getElementById('paymentDetail').textContent = detailText;
                document.getElementById('calculatedPayment').style.display = 'block';
            } else {
                document.getElementById('calculatedPayment').style.display = 'none';
            }
        }

        // æ·»åŠ è´·æ¬¾
        function addLoan(event) {
            event.preventDefault();

            // ä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºå½•å…¥æ—¶é—´
            const recordDate = new Date();
            recordDate.setHours(0, 0, 0, 0);

            const repaymentType = document.getElementById('repaymentType').value;
            
            const loan = {
                id: Date.now(),
                platform: document.getElementById('platform').value,
                amount: parseFloat(document.getElementById('amount').value),
                rate: parseFloat(document.getElementById('rate').value),
                term: parseInt(document.getElementById('term').value),
                repaymentType: repaymentType,
                firstPaymentDate: document.getElementById('firstPaymentDate').value,
                paymentDay: document.getElementById('paymentDay').value ? 
                           parseInt(document.getElementById('paymentDay').value) : null,
                lastDayOfMonth: document.getElementById('lastDayOfMonth').checked,
                createdAt: recordDate.toISOString(),
                paidPayments: {}
            };

            // å¦‚æœæ˜¯éƒ¨åˆ†å®šæœŸè´·æ¬¾ï¼Œä¿å­˜æœ¬é‡‘æ¯”ä¾‹
            if (repaymentType === 'partialTermLoan') {
                loan.principalRatio = parseFloat(document.getElementById('principalRatio').value);
            }

            // è‡ªåŠ¨æ ‡è®°å½•å…¥æ—¥æœŸä¹‹å‰çš„æ‰€æœ‰è¿˜æ¬¾ä¸ºå·²è¿˜
            const schedule = calculatePaymentSchedule(loan);
            let autoPaidCount = 0;
            
            schedule.forEach(payment => {
                const paymentDate = new Date(payment.date);
                paymentDate.setHours(0, 0, 0, 0);
                
                // å¦‚æœè¿˜æ¬¾æ—¥æœŸåœ¨å½•å…¥æ—¥æœŸä¹‹å‰ï¼Œè‡ªåŠ¨æ ‡è®°ä¸ºå·²è¿˜
                if (paymentDate < recordDate) {
                    loan.paidPayments[payment.date] = true;
                    autoPaidCount++;
                }
            });

            loans.push(loan);
            saveData();
            renderCalendar();
            renderLoansList();
            updateOverview();
            
            document.getElementById('loanForm').reset();
            document.getElementById('calculatedPayment').style.display = 'none';
            document.getElementById('principalRatioGroup').classList.add('hidden');
            
            if (autoPaidCount > 0) {
                alert(`âœ… è´·æ¬¾æ·»åŠ æˆåŠŸï¼å·²è‡ªåŠ¨æ ‡è®° ${autoPaidCount} æœŸå†å²è¿˜æ¬¾ä¸ºå·²è¿˜ã€‚`);
            } else {
                alert('âœ… è´·æ¬¾æ·»åŠ æˆåŠŸï¼');
            }
        }

        // è®¡ç®—è¿˜æ¬¾è®¡åˆ’
        function calculatePaymentSchedule(loan) {
            const payments = [];
            const monthlyRate = loan.rate / 100 / 12;
            let remainingPrincipal = loan.amount;

            let currentDate = new Date(loan.firstPaymentDate);

            if (loan.repaymentType === 'termLoan') {
                // å®šæœŸè´·æ¬¾ï¼šåˆ°æœŸä¸€æ¬¡æ€§è¿˜æœ¬ä»˜æ¯
                // è®¡ç®—ç¬¬termä¸ªæœˆçš„æ—¥æœŸ
                let maturityDate = new Date(loan.firstPaymentDate);
                for (let i = 1; i < loan.term; i++) {
                    maturityDate = getNextPaymentDate(maturityDate, loan);
                }
                
                const totalInterest = loan.amount * (loan.rate / 100) * (loan.term / 12);
                const totalPayment = loan.amount + totalInterest;
                
                payments.push({
                    period: loan.term,
                    date: maturityDate.toISOString().split('T')[0],
                    amount: totalPayment,
                    principal: loan.amount,
                    interest: totalInterest,
                    remainingPrincipal: 0
                });
            } else if (loan.repaymentType === 'partialTermLoan') {
                // éƒ¨åˆ†å®šæœŸè´·æ¬¾ï¼šæ¯æœˆè¿˜åˆ©æ¯+éƒ¨åˆ†æœ¬é‡‘ï¼Œåˆ°æœŸè¿˜å‰©ä½™æœ¬é‡‘
                const principalRatio = loan.principalRatio / 100;
                const monthlyPrincipalTotal = loan.amount * principalRatio;
                const monthlyPrincipal = monthlyPrincipalTotal / loan.term;
                const finalPrincipal = loan.amount * (1 - principalRatio);
                
                let currentRemainingPrincipal = loan.amount;
                
                for (let i = 0; i < loan.term; i++) {
                    const paymentDate = new Date(currentDate);
                    const interest = currentRemainingPrincipal * monthlyRate;
                    
                    let principal = monthlyPrincipal;
                    let paymentAmount = principal + interest;
                    
                    // æœ€åä¸€æœŸåŠ ä¸Šå‰©ä½™æœ¬é‡‘
                    if (i === loan.term - 1) {
                        principal += finalPrincipal;
                        paymentAmount = principal + interest;
                    }
                    
                    currentRemainingPrincipal -= monthlyPrincipal;
                    
                    payments.push({
                        period: i + 1,
                        date: paymentDate.toISOString().split('T')[0],
                        amount: paymentAmount,
                        principal: principal,
                        interest: interest,
                        remainingPrincipal: i === loan.term - 1 ? 0 : currentRemainingPrincipal + finalPrincipal
                    });
                    
                    currentDate = getNextPaymentDate(currentDate, loan);
                }
            } else {
                // ç­‰é¢æœ¬æ¯å’Œç­‰é¢æœ¬é‡‘
                for (let i = 0; i < loan.term; i++) {
                    let paymentAmount = 0;
                    let principal = 0;
                    let interest = 0;

                    if (loan.repaymentType === 'equalPrincipalInterest') {
                        // ç­‰é¢æœ¬æ¯
                        if (monthlyRate === 0) {
                            paymentAmount = loan.amount / loan.term;
                            principal = paymentAmount;
                            interest = 0;
                        } else {
                            paymentAmount = loan.amount * monthlyRate * Math.pow(1 + monthlyRate, loan.term) / 
                                          (Math.pow(1 + monthlyRate, loan.term) - 1);
                            interest = remainingPrincipal * monthlyRate;
                            principal = paymentAmount - interest;
                        }
                    } else {
                        // ç­‰é¢æœ¬é‡‘
                        principal = loan.amount / loan.term;
                        interest = remainingPrincipal * monthlyRate;
                        paymentAmount = principal + interest;
                    }

                    remainingPrincipal -= principal;

                    const paymentDate = new Date(currentDate);
                    
                    payments.push({
                        period: i + 1,
                        date: paymentDate.toISOString().split('T')[0],
                        amount: paymentAmount,
                        principal: principal,
                        interest: interest,
                        remainingPrincipal: Math.max(0, remainingPrincipal)
                    });

                    // è®¡ç®—ä¸‹ä¸€ä¸ªè¿˜æ¬¾æ—¥
                    currentDate = getNextPaymentDate(currentDate, loan);
                }
            }

            return payments;
        }

        // è·å–ä¸‹ä¸€ä¸ªè¿˜æ¬¾æ—¥
        function getNextPaymentDate(currentDate, loan) {
            const nextDate = new Date(currentDate);
            
            // å®šæœŸè´·æ¬¾ç›´æ¥åŠ æœˆä»½
            if (loan.repaymentType === 'termLoan') {
                nextDate.setMonth(nextDate.getMonth() + 1);
                return nextDate;
            }
            
            nextDate.setMonth(nextDate.getMonth() + 1);

            if (loan.lastDayOfMonth) {
                // è®¾ç½®ä¸ºä¸‹æœˆæœ€åä¸€å¤©
                nextDate.setMonth(nextDate.getMonth() + 1, 0);
            } else if (loan.paymentDay) {
                // è®¾ç½®ä¸ºæŒ‡å®šæ—¥æœŸ
                const targetDay = loan.paymentDay;
                nextDate.setDate(1);
                
                // è·å–è¯¥æœˆæœ€åä¸€å¤©
                const lastDay = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                
                // å¦‚æœæ˜¯29ã€30ã€31ä¸”å½“æœˆæ²¡æœ‰ï¼Œåˆ™è°ƒæ•´
                if (targetDay > lastDay) {
                    nextDate.setDate(lastDay);
                } else {
                    nextDate.setDate(targetDay);
                }
            }

            return nextDate;
        }

        // æ£€æŸ¥è¿˜æ¬¾æ˜¯å¦å·²æ”¯ä»˜
        function isPaymentPaid(loanId, paymentDate) {
            const loan = loans.find(l => l.id === loanId);
            if (!loan || !loan.paidPayments) return false;
            return loan.paidPayments[paymentDate] === true;
        }

        // åˆ‡æ¢è¿˜æ¬¾çŠ¶æ€
        function togglePaymentStatus(loanId, paymentDate, event) {
            event.stopPropagation();
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;

            if (!loan.paidPayments) {
                loan.paidPayments = {};
            }

            loan.paidPayments[paymentDate] = !loan.paidPayments[paymentDate];
            
            saveData();
            renderCalendar();
            updateOverview();
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // æ›´æ–°æœˆä»½æ˜¾ç¤º
            const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                              'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
            document.getElementById('currentMonth').textContent = `${year}å¹´ ${monthNames[month]}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const prevDaysInMonth = prevLastDay.getDate();

            let calendarHTML = '';
            
            // æ˜ŸæœŸå¤´
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekDays.forEach(day => {
                calendarHTML += `<div class="calendar-header">${day}</div>`;
            });

            // ä¸Šæœˆæ—¥æœŸ
            for (let i = firstDayWeek - 1; i >= 0; i--) {
                const day = prevDaysInMonth - i;
                calendarHTML += `<div class="calendar-day other-month">
                    <div class="day-number">${day}</div>
                </div>`;
            }

            // å½“æœˆæ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                
                const payments = getPaymentsForDate(dateStr);
                
                let paymentsHTML = '';
                payments.forEach(payment => {
                    const isPaid = isPaymentPaid(payment.loanId, payment.date);
                    const color = getLoanColor(payment.loanId);
                    
                    paymentsHTML += `
                        <div class="payment-item ${isPaid ? 'paid' : ''}" 
                             style="background: ${color};"
                             onclick="togglePaymentStatus(${payment.loanId}, '${payment.date}', event)"
                             title="ç‚¹å‡»åˆ‡æ¢è¿˜æ¬¾çŠ¶æ€">
                            <div class="platform">${payment.platform}</div>
                            <div class="amount">Â¥${payment.amount.toFixed(2)}</div>
                            <div class="payment-status">${isPaid ? 'âœ“ å·²è¿˜' : 'å¾…è¿˜æ¬¾'}</div>
                        </div>
                    `;
                });

                calendarHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        <div class="day-number">${day}</div>
                        ${paymentsHTML}
                    </div>
                `;
            }

            // ä¸‹æœˆæ—¥æœŸ
            const remainingDays = 42 - (firstDayWeek + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                calendarHTML += `<div class="calendar-day other-month">
                    <div class="day-number">${day}</div>
                </div>`;
            }

            document.getElementById('calendar').innerHTML = calendarHTML;
        }

        // è·å–æŒ‡å®šæ—¥æœŸçš„è¿˜æ¬¾
        function getPaymentsForDate(dateStr) {
            const payments = [];
            
            loans.forEach(loan => {
                const schedule = calculatePaymentSchedule(loan);
                schedule.forEach(payment => {
                    if (payment.date === dateStr) {
                        payments.push({
                            loanId: loan.id,
                            platform: loan.platform,
                            amount: payment.amount,
                            period: payment.period,
                            date: payment.date
                        });
                    }
                });
            });

            return payments;
        }

        // è·å–è¿˜æ¬¾ç±»å‹ä¸­æ–‡åç§°
        function getRepaymentTypeName(type) {
            const typeNames = {
                'equalPrincipalInterest': 'ç­‰é¢æœ¬æ¯',
                'equalPrincipal': 'ç­‰é¢æœ¬é‡‘',
                'termLoan': 'å®šæœŸè´·æ¬¾',
                'partialTermLoan': 'éƒ¨åˆ†å®šæœŸ'
            };
            return typeNames[type] || type;
        }

        // æ¸²æŸ“è´·æ¬¾åˆ—è¡¨
        function renderLoansList() {
            const loansListDiv = document.getElementById('loansList');
            
            if (loans.length === 0) {
                loansListDiv.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— è´·æ¬¾è®°å½•</p>
                    </div>
                `;
                return;
            }

            let html = '';
            loans.forEach(loan => {
                const schedule = calculatePaymentSchedule(loan);
                
                // è®¡ç®—å‰©ä½™æœªè¿˜çš„æœ¬é‡‘å’Œåˆ©æ¯
                let remainingPrincipal = 0;
                let remainingInterest = 0;
                
                schedule.forEach(payment => {
                    const isPaid = isPaymentPaid(loan.id, payment.date);
                    if (!isPaid) {
                        remainingPrincipal += payment.principal;
                        remainingInterest += payment.interest;
                    }
                });
                
                // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªè¿˜æ¬¾é¡¹
                const nextPayment = schedule.find(p => {
                    const isPaid = isPaymentPaid(loan.id, p.date);
                    return !isPaid;
                });

                const color = getLoanSolidColor(loan.id);
                const typeName = getRepaymentTypeName(loan.repaymentType);

                html += `
                    <div class="loan-item">
                        <div class="loan-item-header">
                            <div class="loan-item-platform">
                                <span class="loan-color-badge" style="background: ${color};"></span>
                                ${loan.platform}
                            </div>
                            <div class="loan-item-amount">å‰©ä½™: Â¥${remainingPrincipal.toFixed(2)}</div>
                        </div>
                        <div class="loan-item-details">
                            <div>åŸå§‹é‡‘é¢: Â¥${loan.amount.toFixed(2)}</div>
                            <div>åˆ©ç‡: ${loan.rate}%</div>
                            <div>æœŸæ•°: ${loan.term}ä¸ªæœˆ</div>
                            <div>æ–¹å¼: ${typeName}</div>
                            <div>å‰©ä½™åˆ©æ¯: Â¥${remainingInterest.toFixed(2)}</div>
                            ${nextPayment ? `<div>ä¸‹æ¬¡è¿˜æ¬¾: ${nextPayment.date} (Â¥${nextPayment.amount.toFixed(2)})</div>` : '<div>âœ… å·²è¿˜æ¸…</div>'}
                        </div>
                        <div class="loan-item-actions">
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" 
                                    onclick="editLoan(${loan.id})">ç¼–è¾‘</button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" 
                                    onclick="deleteLoan(${loan.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });

            loansListDiv.innerHTML = html;
        }

        // æ›´æ–°æ€»è§ˆ
        function updateOverview() {
            // åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®
            let totalRemainingPrincipal = 0;   // å‰©ä½™æœ¬é‡‘æ€»é¢
            let totalRemainingInterest = 0;    // å‰©ä½™åˆ©æ¯æ€»é¢
            let totalPaidPrincipal = 0;        // å·²è¿˜æœ¬é‡‘
            let totalPaidInterest = 0;         // å·²ä»˜åˆ©æ¯
            let monthlyPayment = 0;            // æœ¬æœˆåº”è¿˜
            
            // è®¡ç®—æœ¬æœˆçš„èµ·æ­¢æ—¥æœŸ
            const today = new Date();
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            // éå†æ‰€æœ‰è´·æ¬¾
            loans.forEach(loan => {
                const schedule = calculatePaymentSchedule(loan);
                
                // éå†æ¯æœŸè¿˜æ¬¾
                schedule.forEach(payment => {
                    const paymentDate = new Date(payment.date);
                    const isPaid = isPaymentPaid(loan.id, payment.date);
                    
                    if (isPaid) {
                        // å·²è¿˜æ¬¾
                        totalPaidPrincipal += payment.principal;
                        totalPaidInterest += payment.interest;
                    } else {
                        // æœªè¿˜æ¬¾
                        totalRemainingPrincipal += payment.principal;
                        totalRemainingInterest += payment.interest;
                        
                        // è®¡ç®—æœ¬æœˆåº”è¿˜ï¼ˆæœªè¿˜çš„ï¼‰
                        if (paymentDate >= monthStart && paymentDate <= monthEnd) {
                            monthlyPayment += payment.amount;
                        }
                    }
                });
            });

            // è®¡ç®—å¹³å‡åˆ©ç‡
            const avgRate = loans.length > 0 ? 
                           loans.reduce((sum, loan) => sum + loan.rate, 0) / loans.length : 0;

            // ç´¯è®¡è¿˜æ¬¾æ€»é¢
            const totalPaid = totalPaidPrincipal + totalPaidInterest;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalDebt').textContent = totalRemainingPrincipal.toFixed(2);
            document.getElementById('remainingInterest').textContent = totalRemainingInterest.toFixed(2);
            document.getElementById('monthlyPayment').textContent = monthlyPayment.toFixed(2);
            document.getElementById('loanCount').textContent = loans.length;
            document.getElementById('avgRate').textContent = avgRate.toFixed(2);
            document.getElementById('paidPrincipal').textContent = totalPaidPrincipal.toFixed(2);
            document.getElementById('paidInterest').textContent = totalPaidInterest.toFixed(2);
            document.getElementById('totalPaid').textContent = totalPaid.toFixed(2);
        }

        // è®¡ç®—æ—¶é—´æ®µè¿˜æ¬¾
        function calculateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©èµ·æ­¢æ—¥æœŸ');
                return;
            }

            let totalAmount = 0;
            const start = new Date(startDate);
            const end = new Date(endDate);

            loans.forEach(loan => {
                const schedule = calculatePaymentSchedule(loan);
                schedule.forEach(payment => {
                    const paymentDate = new Date(payment.date);
                    if (paymentDate >= start && paymentDate <= end) {
                        totalAmount += payment.amount;
                    }
                });
            });

            document.getElementById('rangeAmount').textContent = totalAmount.toFixed(2);
            document.getElementById('rangeResult').style.display = 'block';
        }

        // ç¼–è¾‘è´·æ¬¾
        function editLoan(id) {
            const loan = loans.find(l => l.id === id);
            if (!loan) return;

            document.getElementById('editLoanId').value = loan.id;
            document.getElementById('editPlatform').value = loan.platform;
            document.getElementById('editAmount').value = loan.amount;
            document.getElementById('editRate').value = loan.rate;
            document.getElementById('editTerm').value = loan.term;
            document.getElementById('editRepaymentType').value = loan.repaymentType;
            document.getElementById('editFirstPaymentDate').value = loan.firstPaymentDate;
            document.getElementById('editPaymentDay').value = loan.paymentDay || '';
            document.getElementById('editLastDayOfMonth').checked = loan.lastDayOfMonth;
            
            if (loan.repaymentType === 'partialTermLoan') {
                document.getElementById('editPrincipalRatio').value = loan.principalRatio || '';
            }

            handleEditRepaymentTypeChange();
            document.getElementById('editModal').classList.add('active');
        }

        // æ›´æ–°è´·æ¬¾
        function updateLoan(event) {
            event.preventDefault();

            const id = parseInt(document.getElementById('editLoanId').value);
            const index = loans.findIndex(l => l.id === id);
            
            if (index !== -1) {
                const oldPaidPayments = loans[index].paidPayments || {};
                const oldCreatedAt = loans[index].createdAt;
                const repaymentType = document.getElementById('editRepaymentType').value;
                
                loans[index] = {
                    ...loans[index],
                    platform: document.getElementById('editPlatform').value,
                    amount: parseFloat(document.getElementById('editAmount').value),
                    rate: parseFloat(document.getElementById('editRate').value),
                    term: parseInt(document.getElementById('editTerm').value),
                    repaymentType: repaymentType,
                    firstPaymentDate: document.getElementById('editFirstPaymentDate').value,
                    paymentDay: document.getElementById('editPaymentDay').value ? 
                               parseInt(document.getElementById('editPaymentDay').value) : null,
                    lastDayOfMonth: document.getElementById('editLastDayOfMonth').checked,
                    paidPayments: oldPaidPayments,
                    createdAt: oldCreatedAt
                };

                if (repaymentType === 'partialTermLoan') {
                    loans[index].principalRatio = parseFloat(document.getElementById('editPrincipalRatio').value);
                }

                saveData();
                renderCalendar();
                renderLoansList();
                updateOverview();
                closeEditModal();
                
                alert('âœ… è´·æ¬¾æ›´æ–°æˆåŠŸï¼');
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // åˆ é™¤è´·æ¬¾
        function deleteLoan(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¬”è´·æ¬¾å—ï¼Ÿ')) {
                loans = loans.filter(l => l.id !== id);
                saveData();
                renderCalendar();
                renderLoansList();
                updateOverview();
                alert('âœ… è´·æ¬¾å·²åˆ é™¤ï¼');
            }
        }

        // æ˜¾ç¤ºè´·æ¬¾è¯¦æƒ…
        function showLoanDetails(id) {
            editLoan(id);
        }

        // æ—¥å†å¯¼èˆª
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        // æ•°æ®æŒä¹…åŒ–
        function saveData() {
            localStorage.setItem('loanManagementData', JSON.stringify(loans));
        }

        function loadData() {
            const data = localStorage.getItem('loanManagementData');
            if (data) {
                loans = JSON.parse(data);
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(loans, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è´·æ¬¾æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedLoans = JSON.parse(e.target.result);
                    if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        loans = importedLoans;
                        saveData();
                        renderCalendar();
                        renderLoansList();
                        updateOverview();
                        alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    }
                } catch (error) {
                    alert('âŒ æ•°æ®æ ¼å¼é”™è¯¯ï¼Œå¯¼å…¥å¤±è´¥ï¼');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
    </script>
</body>
</html>