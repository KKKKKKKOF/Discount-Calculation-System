<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ›åšæœ‹å…‹é…ç½®å•ï¼ˆå®æ—¶è®¡ç®— + ç¾åŒ–å¯¼å‡º + å¯¼å…¥/å¯¼å‡ºï¼‰</title>
<style>
  /* ========== CYBERPUNK THEME ========== */
  :root{
    --bg:#0b0f1a;
    --panel:#0f1526;
    --panel-2:#0c1222;
    --text:#e6f3ff;
    --muted:#8aa0bf;
    --neon1:#00ffd1;   /* é’è‰²éœ“è™¹ */
    --neon2:#ff3fd1;   /* å“çº¢éœ“è™¹ */
    --neon3:#7cf23a;   /* ç”µå­ç»¿ */
    --line:#1c2547;
    --danger:#ff5470;
    --ok:#3cf5a9;
    --warning:#f8ff6a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(1200px 800px at 10% 10%, #12172a 0%, #0b0f1a 60%) fixed;
    color:var(--text);
    font:14px/1.6 ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC","Hiragino Sans GB","Microsoft YaHei","Noto Sans CJK SC", sans-serif;
  }
  .shell{max-width:1180px;margin:28px auto;padding:0 18px}
  .card{
    background:linear-gradient(180deg, rgba(15,21,38,.96) 0%, rgba(12,18,34,.96) 100%);
    border:1px solid #1a2344;border-radius:16px;overflow:hidden;position:relative;
    box-shadow:0 20px 60px rgba(0,0,0,.45), 0 0 0 1px rgba(0,255,209,.08) inset, 0 0 0 1px rgba(255,63,209,.06);
  }
  .scanline:before{
    content:"";position:absolute;inset:0;
    background:repeating-linear-gradient(180deg, rgba(255,255,255,.03) 0 1px, transparent 1px 3px);
    mix-blend-mode:overlay;pointer-events:none;
  }
  .header{
    padding:22px;border-bottom:1px solid var(--line);
    background:
      radial-gradient(500px 300px at 0% 0%, rgba(0,255,209,.10), transparent 60%),
      radial-gradient(600px 400px at 100% 0%, rgba(255,63,209,.10), transparent 60%);
  }
  .title{
    display:flex;align-items:center;gap:12px;margin-bottom:10px
  }
  .title h1{margin:0;font-size:22px;letter-spacing:.4px}
  .badge{
    display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;
    color:#061218;background:linear-gradient(90deg, var(--neon1), var(--neon2));
    font-weight:800;text-transform:uppercase;letter-spacing:.6px
  }
  .sub{margin:0;color:var(--muted)}
  .grid{
    display:grid;gap:12px 16px;margin-top:16px;
    grid-template-columns: repeat(4,1fr);
  }
  .field{display:flex;flex-direction:column;gap:6px}
  .label{font-size:12px;color:var(--muted)}
  .input{
    height:40px;border:1px solid #1c2547;border-radius:10px;padding:0 12px;background:rgba(10,14,26,.7);outline:none;color:var(--text);
    transition:.15s border-color,.15s box-shadow;
    box-shadow:inset 0 0 0 1px rgba(0,255,209,.06);
  }
  .input:focus{
    border-color:rgba(0,255,209,.6);
    box-shadow:0 0 0 3px rgba(0,255,209,.15), 0 0 12px rgba(255,63,209,.15) inset;
  }
  .toolbar{
    display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;padding:12px 16px;border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, rgba(18,23,42,.8), rgba(12,18,34,.8));
  }
  .btn{
    appearance:none;border:1px solid #233060;background:linear-gradient(180deg,#101633,#0b1128);color:var(--text);
    padding:8px 14px;border-radius:10px;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    text-shadow:0 0 6px rgba(0,255,209,.15);
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(0,255,209,.10)}
  .btn.primary{border-color:rgba(0,255,209,.6);background:linear-gradient(90deg, rgba(0,255,209,.15), rgba(255,63,209,.15))}
  .btn.accent{border-color:rgba(255,63,209,.6);background:linear-gradient(90deg, rgba(255,63,209,.18), rgba(124,242,58,.12))}
  .btn.ghost{border-color:#2a366b}
  .table-wrap{padding:14px 16px 96px 16px;position:relative}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid #1a2549;border-radius:12px;overflow:hidden}
  thead th{
    background:linear-gradient(180deg,#0f1634,#0c1226);color:#cfe8ff;font-weight:800;text-align:left;padding:10px 12px;border-bottom:1px solid #1a2549;
  }
  tbody td{padding:8px 12px;border-bottom:1px solid #132045;vertical-align:middle;background:rgba(10,14,26,.6)}
  tbody tr:last-child td{border-bottom:none}
  .col-idx{width:42px;color:var(--muted)}
  .col-name{width:128px;font-weight:700}
  .col-model{min-width:260px}
  .col-price{width:180px}
  .col-qty{width:120px}
  .col-subtotal{width:160px;text-align:right;font-variant-numeric:tabular-nums}
  .pill{
    height:36px;border:1px solid #22305f;border-radius:999px;padding:0 12px;width:100%;outline:none;background:rgba(8,12,24,.8);color:var(--text)
  }
  .pill:focus{border-color:rgba(255,63,209,.6);box-shadow:0 0 0 3px rgba(255,63,209,.12)}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .price-wrap{position:relative}
  .price-wrap .prefix{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#7feeda;pointer-events:none}
  .price-wrap .pill{padding-left:26px}
  .invalid{border-color:var(--danger)!important;box-shadow:0 0 0 3px rgba(255,84,112,.18)!important}
  .summary-bar{
    position:sticky;bottom:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;
    padding:12px 16px;border-top:1px solid #1a2549;background:rgba(11,15,26,.85);backdrop-filter:blur(6px);
    border-bottom-left-radius:16px;border-bottom-right-radius:16px;
  }
  .sum-left{display:flex;gap:14px;color:#b9c8e6}
  .sum-right{font-size:22px;font-weight:900;color:var(--neon1);text-shadow:0 0 10px rgba(0,255,209,.6)}
  .hint{color:var(--muted);font-size:12px;margin-left:8px}
  .icon-cell{display:flex;align-items:center;gap:8px}
  .icon{width:18px;height:18px;display:inline-block;vertical-align:middle}

  @media (max-width:1000px){ .grid{grid-template-columns: repeat(2,1fr)} .col-model{min-width:200px} }
  @media print{ .toolbar,.summary-bar{display:none!important} .card{box-shadow:none;border:none} }

  /* ========== EXPORT TEMPLATE (A4, CYBERPUNK) ========== */
  .export-root{
    position:fixed;left:-99999px;top:0;width:794px; /* ~ A4 width @96dpi */
    background:#0a0e1a;color:var(--text);padding:28px;
    border:1px solid #17224a;border-radius:14px;
    box-shadow:0 0 0 1px rgba(0,255,209,.10), 0 0 0 1px rgba(255,63,209,.08) inset;
  }
  .ex-header{
    display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:18px;
    background:
      linear-gradient(90deg, rgba(0,255,209,.10), rgba(255,63,209,.10)),
      linear-gradient(180deg, #101633, #0c1226);
    border:1px solid #1a2549;border-radius:12px;padding:16px;
    box-shadow:inset 0 0 16px rgba(0,255,209,.10);
  }
  .ex-title{
    display:flex;align-items:center;gap:12px
  }
  .ex-title h2{margin:0;font-size:20px;letter-spacing:.4px}
  .ex-badge{padding:4px 8px;border-radius:999px;background:linear-gradient(90deg,var(--neon1),var(--neon2));color:#061218;font-weight:900}
  .ex-meta{display:grid;grid-template-columns:repeat(3,1fr);gap:8px 16px;color:#bcd0ef;margin-top:6px}
  .ex-meta .k{color:#86a5d6}
  .ex-table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid #1a2549;border-radius:12px;overflow:hidden}
  .ex-table thead th{
    background:linear-gradient(180deg,#101633,#0d142a);color:#cfe8ff;text-align:left;padding:10px 12px;border-bottom:1px solid #1a2549;font-weight:800
  }
  .ex-table tbody td{padding:10px 12px;border-bottom:1px solid #142046;background:rgba(10,14,26,.7)}
  .ex-table tbody tr:last-child td{border-bottom:none}
  .ex-col-idx{width:40px;color:#9db4da}
  .ex-col-item{width:150px;font-weight:700}
  .ex-col-model{min-width:240px}
  .ex-col-price{width:120px}
  .ex-col-qty{width:80px}
  .ex-col-sub{width:140px;text-align:right}
  .ex-item-icon{width:18px;height:18px;margin-right:8px;vertical-align:-3px}
  .ex-summary{
    margin-top:14px;border:1px solid #1a2549;border-radius:12px;padding:14px;background:linear-gradient(180deg,#101633,#0d142a);
    display:flex;justify-content:space-between;align-items:center
  }
  .ex-total{font-size:22px;font-weight:900;color:var(--neon1);text-shadow:0 0 10px rgba(0,255,209,.6)}
  .ex-note{color:#97acd2;font-size:12px}
  .logo-mark{
    font-weight:900;letter-spacing:1px;color:#0a1124;background:linear-gradient(90deg,var(--neon1),var(--neon2));padding:6px 10px;border-radius:8px
  }
</style>
    <!-- 
    ========================================
    æ­¥éª¤1: å°†æ‚¨åŸHTMLæ–‡ä»¶ <head> æ ‡ç­¾å†…çš„å†…å®¹æ”¾åœ¨è¿™é‡Œ
    ï¼ˆå¦‚ <title>ã€<link>ã€<style> ç­‰ï¼Œä½†ä¸è¦é‡å¤ charset å’Œ viewportï¼‰
    ========================================
    -->
    
    <title>è¯·è¾“å…¥å¯†ç </title>
    
    <style>
        /* å¯†ç ä¿æŠ¤ç•Œé¢æ ·å¼ */
        #password-protection {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .password-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        
        .password-box h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .password-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }
        
        .password-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .password-box button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .password-box button:hover {
            background: #5568d3;
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
            min-height: 20px;
        }
        
        #main-content {
            display: none;
        }
    </style>
</head>
<body>

    <!-- å¯†ç ä¿æŠ¤ç•Œé¢ -->
    <div id="password-protection">
        <div class="password-box">
            <h2>ğŸ”’ è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
            <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="off" />
            <button onclick="checkPassword()">ç¡®è®¤</button>
            <div class="error-message" id="error-message"></div>
        </div>
    </div>

    <!-- å®é™…ç½‘é¡µå†…å®¹åŒºåŸŸ -->
    <div id="main-content">
          <div class="shell">
    <div class="card scanline" id="quote">
      <div class="header">
        <div class="title">
          <h1>é…ç½®å• Â· CYBER</h1>
          <span class="badge">Realtime</span>
        </div>
        <p class="sub">èµ›åšæœ‹å…‹é£å®æ—¶é…ç½®å•ï¼šå¡«å†™å‹å·ã€å•ä»·ä¸æ•°é‡ï¼Œç³»ç»Ÿå³æ—¶è®¡ç®—ï¼›å¯¼å‡ºä½¿ç”¨ç¾åŒ–æ¨¡æ¿å¹¶è‡ªåŠ¨è¿‡æ»¤ç©ºé¡¹ã€‚</p>
        <div class="grid">
          <label class="field">
            <span class="label">é—¨åº—åç§°</span>
            <input id="storeName" class="input" placeholder="å¦‚ï¼šä¸œèå¸‚XXç”µè„‘ç»„è£…åº—" />
          </label>
          <label class="field">
            <span class="label">å®¢æˆ·å§“å</span>
            <input id="customerName" class="input" placeholder="å¦‚ï¼šå¼ ä¸‰" />
          </label>
          <label class="field">
            <span class="label">è”ç³»ç”µè¯</span>
            <input id="phone" class="input" inputmode="tel" placeholder="å¦‚ï¼š138****8888" />
          </label>
          <label class="field">
            <span class="label">æŠ¥ä»·æ—¥æœŸ</span>
            <input id="quoteDate" class="input" type="date" />
          </label>
          <label class="field">
            <span class="label">å•å·ï¼ˆå¯é€‰ï¼‰</span>
            <input id="orderNo" class="input" placeholder="å¦‚ï¼šDG-2025-001" />
          </label>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn ghost" id="resetBtn">æ¸…ç©ºå†…å®¹</button>
        <button class="btn" id="printBtn">æ‰“å°</button>
        <button class="btn" id="importBtn">å¯¼å…¥é…ç½®</button>
        <button class="btn" id="exportBtn">å¯¼å‡ºé…ç½®</button>
        <button class="btn accent" id="pngBtn">å¯¼å‡º PNGï¼ˆç¾åŒ–ï¼‰</button>
        <button class="btn primary" id="pdfBtn">å¯¼å‡º PDFï¼ˆç¾åŒ–ï¼‰</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="col-idx">#</th>
              <th class="col-name">é…ä»¶</th>
              <th class="col-model">å‹å· / è§„æ ¼ / å¤‡æ³¨</th>
              <th class="col-price">å•ä»·ï¼ˆÂ¥ï¼‰</th>
              <th class="col-qty">æ•°é‡</th>
              <th class="col-subtotal">åˆè®¡ï¼ˆÂ¥ï¼‰</th>
            </tr>
          </thead>
          <tbody id="itemsBody">
            <!-- å°†ç”± JS æ¸²æŸ“ -->
          </tbody>
        </table>

        <div class="summary-bar">
          <div class="sum-left">
            <span>é¡¹ç›®æ•°ï¼š<strong id="itemCount">0</strong></span>
            <span>å·²é€‰é¡¹ç›®ï¼š<strong id="selectedCount">0</strong></span>
            <span>æ€»ä»¶æ•°ï¼š<strong id="pieceCount">0</strong></span>
            <span class="hint">æ•°é‡ä¸º 0 æˆ–ç©ºå€¼ä¸ä¼šè¿›å…¥å¯¼å‡º</span>
          </div>
          <div class="sum-right" id="grandTotal">Â¥0.00</div>
        </div>
      </div>
    </div>
  </div>

  <!-- EXPORT TEMPLATE (off-screen, but visible to canvas) -->
  <div id="exportRoot" class="export-root" style="display:none"></div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // =================== æ•°æ®ä¸è¡Œæ¸²æŸ“ ===================
    const PRESETS = [
      "å¤„ç†å™¨","ä¸»æ¿","å†…å­˜","æ˜¾å¡","æœºæ¢°ç¡¬ç›˜","å›ºæ€ç¡¬ç›˜","ç”µæº","æ•£çƒ­å™¨","æœºç®±","æ˜¾ç¤ºå™¨","é”®ç›˜","é¼ æ ‡","å…¶ä»–"
    ];
    const itemsBody = document.getElementById('itemsBody');

    function renderRows(){
      itemsBody.innerHTML = '';
      PRESETS.forEach((name, i) => {
        const tr = document.createElement('tr');
        tr.dataset.item = name;
        tr.innerHTML = `
          <td class="col-idx">${i+1}</td>
          <td class="col-name">
            <span class="icon-cell">
              <span class="icon">${getIcon(name,'#7feeda')}</span>${name}
            </span>
          </td>
          <td><input class="pill" placeholder="${getPlaceholder(name)}" /></td>
          <td>
            <div class="price-wrap">
              <span class="prefix">Â¥</span>
              <input class="pill num price" data-type="price" placeholder="0.00" inputmode="decimal" />
            </div>
          </td>
          <td><input class="pill num qty" data-type="qty" type="number" min="0" step="1" value="${name==='å†…å­˜' ? 2 : 1}" /></td>
          <td class="col-subtotal"><strong data-role="rowTotal">Â¥0.00</strong></td>
        `;
        itemsBody.appendChild(tr);
      });
      document.getElementById('itemCount').textContent = PRESETS.length;
    }

    function getPlaceholder(name){
      switch(name){
        case "å¤„ç†å™¨": return "å¦‚ï¼šIntel i5-13400F / AMD R5 5600";
        case "ä¸»æ¿": return "å¦‚ï¼šB760M / B550M / X670";
        case "å†…å­˜": return "å¦‚ï¼š16GB DDR4 3200ï¼ˆå¯å¡«å¥—æ¡ï¼‰";
        case "æ˜¾å¡": return "å¦‚ï¼šRTX 4060 / RX 6700 XT";
        case "æœºæ¢°ç¡¬ç›˜": return "å¦‚ï¼š2TB 7200RPM";
        case "å›ºæ€ç¡¬ç›˜": return "å¦‚ï¼š1TB NVMe Gen4";
        case "ç”µæº": return "å¦‚ï¼š650W é‡‘ç‰Œ å…¨æ¨¡ç»„";
        case "æ•£çƒ­å™¨": return "å¦‚ï¼š240 ä¸€ä½“æ°´å†· / å¡”å¼é£å†·";
        case "æœºç®±": return "å¦‚ï¼šATX / M-ATX å¸¦é£æ‰‡";
        case "æ˜¾ç¤ºå™¨": return "å¦‚ï¼š27\" 2K 165Hz IPS";
        case "é”®ç›˜": return "å¦‚ï¼š87é”® çƒ­æ’æ‹” èŒ¶è½´";
        case "é¼ æ ‡": return "å¦‚ï¼šæ— çº¿ 3395 è½»é‡åŒ–";
        default: return "å¦‚ï¼šç³»ç»Ÿå®‰è£… / å»¶ä¿ / ç†çº¿";
      }
    }

    // =================== SVG å›¾æ ‡ï¼ˆèµ›åšé£çº¿æ¡ï¼‰ ===================
    function getIcon(name, stroke="#7feeda"){
      const s = `stroke="${stroke}" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"`;
      switch(name){
        case "å¤„ç†å™¨": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="6" y="6" width="12" height="12" rx="2"/><path ${s} d="M9 1v3M15 1v3M9 20v3M15 20v3M1 9h3M1 15h3M20 9h3M20 15h3"/></svg>`;
        case "ä¸»æ¿": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="3" y="3" width="18" height="18" rx="2"/><rect ${s} x="7" y="7" width="6" height="6"/><path ${s} d="M17 7v6M15 15h4M7 17h6"/></svg>`;
        case "å†…å­˜": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="3" y="8" width="18" height="8" rx="2"/><path ${s} d="M6 8v8M10 8v8M14 8v8M18 8v8"/></svg>`;
        case "æ˜¾å¡": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="3" y="6" width="14" height="12" rx="2"/><circle ${s} cx="16.5" cy="12" r="3.5"/><path ${s} d="M17 6h4v12h-4"/></svg>`;
        case "æœºæ¢°ç¡¬ç›˜": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="5" y="4" width="14" height="16" rx="2"/><circle ${s} cx="12" cy="10" r="4"/><circle ${s} cx="12" cy="10" r="1"/><path ${s} d="M12 14v4"/></svg>`;
        case "å›ºæ€ç¡¬ç›˜": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="4" y="7" width="16" height="10" rx="2"/><path ${s} d="M7 10h3M7 13h6M17 10v6"/></svg>`;
        case "ç”µæº": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="4" y="6" width="16" height="12" rx="2"/><path ${s} d="M8 12h4l-2 4M17 9v6"/></svg>`;
        case "æ•£çƒ­å™¨": return `<svg class="icon" viewBox="0 0 24 24"><circle ${s} cx="12" cy="12" r="4"/><path ${s} d="M12 2v3M12 19v3M2 12h3M19 12h3M4.5 4.5l2.1 2.1M17.4 17.4l2.1 2.1M19.5 4.5l-2.1 2.1M6.6 17.4l-2.1 2.1"/></svg>`;
        case "æœºç®±": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="6" y="3" width="12" height="18" rx="2"/><path ${s} d="M9 7h6M9 10h6M9 18h6"/></svg>`;
        case "æ˜¾ç¤ºå™¨": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="3" y="4" width="18" height="12" rx="2"/><path ${s} d="M8 20h8M12 16v4"/></svg>`;
        case "é”®ç›˜": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="3" y="7" width="18" height="10" rx="2"/><path ${s} d="M5 9h2M8 9h2M11 9h2M14 9h2M17 9h2M5 12h10M16 12h3"/></svg>`;
        case "é¼ æ ‡": return `<svg class="icon" viewBox="0 0 24 24"><rect ${s} x="8" y="3" width="8" height="18" rx="4"/><path ${s} d="M12 3v5"/></svg>`;
        default: return `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M4 6h16M4 12h16M4 18h16"/></svg>`;
      }
    }

    // =================== æ•°å­—/é‡‘é¢ ===================
    function toHalfWidth(str){ return String(str||'').replace(/[\uFF10-\uFF19\uFF0E\uFF0D]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)); }
    function parsePrice(raw){
      const s = toHalfWidth(raw).replace(/[ï¿¥Â¥å…ƒ,\s]/g,'').replace(/[^\d.\-]/g,'');
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }
    function parseQty(raw){
      const n = Math.floor(parsePrice(raw));
      return Math.max(0, Number.isFinite(n) ? n : 0);
    }
    function money(n){
      const s = (Math.round(n*100)/100).toFixed(2);
      return 'Â¥' + s.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // =================== è®¡ç®— ===================
    function recalcAll(){
      const rows = Array.from(itemsBody.querySelectorAll('tr'));
      let total = 0, pieceCount = 0, selected = 0;
      rows.forEach(tr => {
        const priceInput = tr.querySelector('.price');
        const qtyInput = tr.querySelector('.qty');
        const rowTotalEl = tr.querySelector('[data-role="rowTotal"]');

        const price = parsePrice(priceInput.value);
        const qty = parseQty(qtyInput.value);

        if (priceInput.value.trim()!=='' && price<0) priceInput.classList.add('invalid'); else priceInput.classList.remove('invalid');
        if (qtyInput.value.trim()!=='' && parseFloat(qtyInput.value)<0) qtyInput.classList.add('invalid'); else qtyInput.classList.remove('invalid');

        const rowTotal = qty>0 ? price*qty : 0;
        rowTotalEl.textContent = money(rowTotal);

        total += rowTotal;
        pieceCount += qty;
        if (qty>0 && (tr.querySelector('td:nth-child(3) input').value.trim()!=='' || price>0)) selected++;
      });
      document.getElementById('grandTotal').textContent = money(total);
      document.getElementById('pieceCount').textContent = pieceCount;
      document.getElementById('selectedCount').textContent = selected;
    }

    function bindRealtime(){
      const rerun = ()=>recalcAll();
      itemsBody.addEventListener('input', rerun, true);
      itemsBody.addEventListener('change', rerun, true);
      itemsBody.addEventListener('blur', (e)=>{
        const t = e.target;
        if (t && t.classList.contains('price')){
          const v = parsePrice(t.value);
          t.value = v ? v.toFixed(2) : '';
        }
      }, true);
    }

    // =================== å¯¼å…¥å¯¼å‡ºé…ç½®ï¼ˆJSONï¼‰ ===================
    function collectData(){
      const rows = Array.from(itemsBody.querySelectorAll('tr'));
      return {
        meta: {
          storeName: document.getElementById('storeName').value || '',
          customerName: document.getElementById('customerName').value || '',
          phone: document.getElementById('phone').value || '',
          quoteDate: document.getElementById('quoteDate').value || '',
          orderNo: document.getElementById('orderNo').value || ''
        },
        items: rows.map(tr => {
          const name = tr.dataset.item;
          const model = tr.querySelector('td:nth-child(3) input').value || '';
          const price = parsePrice(tr.querySelector('.price').value);
          const qty = parseQty(tr.querySelector('.qty').value);
          return { name, model, price, qty };
        })
      };
    }

    function applyData(data){
      if (!data) return;
      if (data.meta){
        document.getElementById('storeName').value = data.meta.storeName || '';
        document.getElementById('customerName').value = data.meta.customerName || '';
        document.getElementById('phone').value = data.meta.phone || '';
        document.getElementById('quoteDate').value = data.meta.quoteDate || '';
        document.getElementById('orderNo').value = data.meta.orderNo || '';
      }
      if (Array.isArray(data.items)){
        // å°†ä¼ å…¥ items æ˜ å°„å›é¢„è®¾è¡Œ
        const map = new Map(data.items.map(it=>[it.name, it]));
        Array.from(itemsBody.querySelectorAll('tr')).forEach(tr=>{
          const nm = tr.dataset.item;
          const it = map.get(nm);
          const modelInput = tr.querySelector('td:nth-child(3) input');
          const priceInput = tr.querySelector('.price');
          const qtyInput = tr.querySelector('.qty');
          if (it){
            modelInput.value = it.model || '';
            priceInput.value = (it.price || it.price===0) ? String(it.price) : '';
            qtyInput.value = (it.qty || it.qty===0) ? String(it.qty) : (nm==='å†…å­˜'? 2:1);
          }else{
            modelInput.value = '';
            priceInput.value = '';
            qtyInput.value = (nm==='å†…å­˜'? 2:1);
          }
        });
      }
      recalcAll();
    }

    function downloadJSON(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // =================== ç¾åŒ–å¯¼å‡ºæ¨¡æ¿ ===================
    function buildExportHTML(data){
      const validItems = (data.items||[]).filter(it => {
        const hasContent = (it.model && it.model.trim()!=='') || (it.price > 0);
        return it.qty > 0 && hasContent;
      });

      const total = validItems.reduce((s, it)=> s + it.price*it.qty, 0);
      const rowsHTML = validItems.map((it, idx) => `
        <tr>
          <td class="ex-col-idx">${idx+1}</td>
          <td class="ex-col-item">
            <img class="ex-item-icon" src="data:image/svg+xml;utf8,${encodeURIComponent(getIcon(it.name, '#7feeda').replace('<svg','<svg xmlns=%22http://www.w3.org/2000/svg%22'))}" />
            ${it.name}
          </td>
          <td class="ex-col-model">${escapeHTML(it.model || '')}</td>
          <td class="ex-col-price">${money(it.price)}</td>
          <td class="ex-col-qty">${it.qty}</td>
          <td class="ex-col-sub">${money(it.price * it.qty)}</td>
        </tr>
      `).join('');

      return `
        <div class="ex-header">
          <div>
            <div class="ex-title">
              <span class="logo-mark">CYBER</span>
              <h2>ç”µè„‘ç»„è£…é…ç½®å•</h2>
              <span class="ex-badge">Neon</span>
            </div>
            <div class="ex-meta">
              <div><span class="k">é—¨åº—ï¼š</span>${escapeHTML(data.meta.storeName || 'â€”')}</div>
              <div><span class="k">å®¢æˆ·ï¼š</span>${escapeHTML(data.meta.customerName || 'â€”')}</div>
              <div><span class="k">ç”µè¯ï¼š</span>${escapeHTML(data.meta.phone || 'â€”')}</div>
              <div><span class="k">æ—¥æœŸï¼š</span>${escapeHTML(data.meta.quoteDate || 'â€”')}</div>
              <div><span class="k">å•å·ï¼š</span>${escapeHTML(data.meta.orderNo || 'â€”')}</div>
              <div><span class="k">é¡¹ç›®æ•°ï¼š</span>${validItems.length}</div>
            </div>
          </div>
        </div>

        <table class="ex-table">
          <thead>
            <tr>
              <th class="ex-col-idx">#</th>
              <th class="ex-col-item">é…ä»¶</th>
              <th class="ex-col-model">å‹å· / è§„æ ¼ / å¤‡æ³¨</th>
              <th class="ex-col-price">å•ä»·</th>
              <th class="ex-col-qty">æ•°é‡</th>
              <th class="ex-col-sub">åˆè®¡</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHTML || `<tr><td colspan="6" style="text-align:center;color:#9db4da;padding:24px">æš‚æ— æœ‰æ•ˆé¡¹ç›®</td></tr>`}
          </tbody>
        </table>

        <div class="ex-summary">
          <div class="ex-note">æ³¨ï¼šä»…å¯¼å‡ºæ•°é‡>0 ä¸”å‹å·æˆ–ä»·æ ¼å·²å¡«å†™çš„é¡¹ç›®ï¼›ä»·æ ¼å•ä½ä¸ºäººæ°‘å¸ã€‚</div>
          <div class="ex-total">æ€»ä»·ï¼š${money(total)}</div>
        </div>
      `;
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // =================== å¯¼å‡º PNG / PDFï¼ˆåŸºäºç¾åŒ–æ¨¡æ¿ï¼‰ ===================
    async function exportPNG(){
      const data = collectData();
      const root = document.getElementById('exportRoot');
      root.innerHTML = buildExportHTML(data);
      root.style.display = 'block';
      await new Promise(r=>setTimeout(r, 50));
      const canvas = await html2canvas(root, { backgroundColor:'#0a0e1a', scale:2 });
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = buildFileName('ç¾åŒ–é…ç½®å•','png'); document.body.appendChild(a); a.click(); a.remove();
      root.style.display = 'none';
    }

    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const data = collectData();
      const root = document.getElementById('exportRoot');
      root.innerHTML = buildExportHTML(data);
      root.style.display = 'block';
      await new Promise(r=>setTimeout(r, 50));

      const canvas = await html2canvas(root, { backgroundColor:'#0a0e1a', scale:2 });
      const imgData = canvas.toDataURL('image/png');

      const pdf = new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 8;
      const usableW = pageW - margin*2;
      const imgW = usableW;
      const imgH = imgW * (canvas.height / canvas.width);

      let heightLeft = imgH;
      let position = margin;

      pdf.addImage(imgData, 'PNG', margin, position, imgW, imgH);
      heightLeft -= (pageH - margin*2);

      while (heightLeft > 0) {
        pdf.addPage();
        position = (heightLeft - imgH) + margin; // offset è£å‰ªåˆ†é¡µ
        pdf.addImage(imgData, 'PNG', margin, position, imgW, imgH);
        heightLeft -= (pageH - margin*2);
      }
      pdf.save(buildFileName('ç¾åŒ–é…ç½®å•','pdf'));
      root.style.display = 'none';
    }

    function buildFileName(suffix, ext){
      const g = id => (document.getElementById(id).value || '').replace(/[\\\/:*?"<>|]/g,'').trim();
      const store = g('storeName') || 'é—¨åº—';
      const customer = g('customerName') || 'å®¢æˆ·';
      const date = (document.getElementById('quoteDate').value || '').replaceAll('-','');
      const parts = [store, customer, date, suffix].filter(Boolean);
      return parts.join('-') + '.' + ext;
    }

    // =================== äº‹ä»¶ä¸åˆå§‹åŒ– ===================
    (function init(){
      renderRows();
      bindRealtime();
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      const today = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      if (!document.getElementById('quoteDate').value) document.getElementById('quoteDate').value = today;

      document.getElementById('resetBtn').addEventListener('click', ()=>{
        Array.from(itemsBody.querySelectorAll('tr')).forEach((tr, idx)=>{
          tr.querySelector('td:nth-child(3) input').value = '';
          tr.querySelector('.price').value = '';
          tr.querySelector('.qty').value = (PRESETS[idx]==='å†…å­˜') ? 2 : 1;
          tr.querySelectorAll('.invalid').forEach(el=>el.classList.remove('invalid'));
        });
        recalcAll();
      });
      document.getElementById('printBtn').addEventListener('click', ()=>window.print());
      document.getElementById('pngBtn').addEventListener('click', exportPNG);
      document.getElementById('pdfBtn').addEventListener('click', exportPDF);

      // å¯¼å‡ºé…ç½®ï¼ˆJSONï¼‰
      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const data = collectData();
        const name = buildFileName('é…ç½®æ•°æ®','json');
        downloadJSON(name, data);
      });

      // å¯¼å…¥é…ç½®ï¼ˆJSONï¼‰
      const importFile = document.getElementById('importFile');
      document.getElementById('importBtn').addEventListener('click', ()=>importFile.click());
      importFile.addEventListener('change', (e)=>{
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(reader.result);
            applyData(obj);
          } catch (err){
            alert('é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é€‰æ‹©å¯¼å‡ºçš„ JSON æ–‡ä»¶ã€‚');
          } finally {
            importFile.value = '';
          }
        };
        reader.readAsText(file, 'utf-8');
      });

      recalcAll();
    })();
  </script>
        <!-- 
        ========================================
        æ­¥éª¤2: å°†æ‚¨åŸHTMLæ–‡ä»¶ <body> æ ‡ç­¾å†…çš„æ‰€æœ‰å†…å®¹æ”¾åœ¨è¿™é‡Œ
        ========================================
        -->
        
    </div>

    <script>
        // å¯†ç éªŒè¯å‡½æ•°
        function checkPassword() {
            const input = document.getElementById('password-input');
            const password = input.value;
            const errorMsg = document.getElementById('error-message');
            
            // æ­£ç¡®å¯†ç æ˜¯ "1"
            if (password === '1') {
                // å¯†ç æ­£ç¡®ï¼Œæ˜¾ç¤ºå®é™…å†…å®¹
                document.getElementById('password-protection').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                errorMsg.textContent = '';
            } else if (password.length < 6) {
                // å°‘äº6ä½çš„æç¤º
                errorMsg.textContent = 'âŒ å¯†ç è‡³å°‘ä¸º6ä½';
            } else {
                // å¤§äºç­‰äº6ä½ä½†é”™è¯¯çš„æç¤º
                errorMsg.textContent = 'âŒ å¯†ç é”™è¯¯';
            }
        }
        
        // æ”¯æŒæŒ‰å›è½¦é”®æäº¤
        document.getElementById('password-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                checkPassword();
            }
        });
    </script>
    
    <!-- 
    ========================================
    æ­¥éª¤3: å¦‚æœæ‚¨åŸHTMLæ–‡ä»¶åº•éƒ¨æœ‰ <script> æ ‡ç­¾ï¼Œæ”¾åœ¨è¿™é‡Œ
    ========================================
    -->

</body>
</html>