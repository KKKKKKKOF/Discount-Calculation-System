<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åˆ†è´¦è®¡ç®—ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .mode-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .mode-card.active {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .mode-card .icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .mode-card .mode-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .mode-card .mode-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #4f46e5;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .person-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .person-item {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .person-item.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .person-badge {
            background: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .person-item.selected .person-badge {
            background: white;
            color: var(--primary-color);
        }

        .person-name {
            font-weight: 500;
            font-size: 14px;
        }

        .person-remove {
            margin-left: auto;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--danger-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-card {
            background: var(--bg-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 25px;
            color: white;
            margin-top: 30px;
        }

        .summary-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .summary-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-name {
            font-weight: 600;
            font-size: 16px;
        }

        .summary-amount {
            font-size: 24px;
            font-weight: 700;
        }

        .summary-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .summary-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-upload.has-file {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
            border-style: solid;
        }

        .file-upload input {
            display: none;
        }

        .receipt-preview {
            margin-top: 10px;
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: var(--shadow);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .hidden {
            display: none !important;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content.large {
            max-width: 90vw;
            max-height: 90vh;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .selected-persons-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-color);
            border-radius: 8px;
            min-height: 40px;
        }

        .selected-tag {
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .selected-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
        }

        .amount-input-grid {
            display: grid;
            gap: 15px;
        }

        .amount-input-item {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            align-items: center;
        }

        .clear-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed var(--border-color);
            flex-wrap: wrap;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: rgba(255, 255, 255, 0.5);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .main-content {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .mode-selector {
                grid-template-columns: 1fr;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .amount-input-item {
                grid-template-columns: 1fr;
            }

            .summary-amount {
                font-size: 20px;
            }

            .clear-actions {
                flex-direction: column;
            }

            .clear-actions .btn {
                width: 100%;
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .extra-fee-item {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .info-badge {
            display: inline-block;
            background: var(--warning-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° æ™ºèƒ½åˆ†è´¦è®¡ç®—ç³»ç»Ÿ</h1>
            <p>æ”¯æŒå¤šç§åˆ†è´¦æ¨¡å¼ï¼Œå®æ—¶è®¡ç®—ï¼Œè®©è´¦ç›®æ¸…æ¸…æ¥šæ¥š</p>
        </div>

        <div class="main-content">
            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="section">
                <div class="section-title">é€‰æ‹©è®¡ç®—æ¨¡å¼</div>
                <div class="mode-selector">
                    <div class="mode-card active" data-mode="aa">
                        <div class="icon">ğŸœ</div>
                        <div class="mode-name">AAåˆ¶æ¨¡å¼</div>
                        <div class="mode-desc">å¤šé¡¹æ¶ˆè´¹ï¼Œçµæ´»é€‰äºº</div>
                    </div>
                    <div class="mode-card" data-mode="share">
                        <div class="icon">ğŸ</div>
                        <div class="mode-name">ä¼˜æƒ å…±äº«æ¨¡å¼</div>
                        <div class="mode-desc">ä¼˜æƒ æŒ‰æ¯”ä¾‹åˆ†æ‘Š</div>
                    </div>
                    <div class="mode-card" data-mode="equal">
                        <div class="icon">âœ‚ï¸</div>
                        <div class="mode-name">ä¼˜æƒ å¹³åˆ†æ¨¡å¼</div>
                        <div class="mode-desc">ä¼˜æƒ é‡‘é¢å‡åˆ†</div>
                    </div>
                    <div class="mode-card" data-mode="purchase">
                        <div class="icon">ğŸ›’</div>
                        <div class="mode-name">ä»£è´­æ¨¡å¼</div>
                        <div class="mode-desc">ä»£è´­è´¹ç”¨åˆ†æ‘Š</div>
                    </div>
                    <div class="mode-card" data-mode="custom">
                        <div class="icon">âš™ï¸</div>
                        <div class="mode-name">è‡ªå®šä¹‰æ¨¡å¼</div>
                        <div class="mode-desc">æ‰‹åŠ¨è¾“å…¥é‡‘é¢</div>
                    </div>
                </div>
            </div>

            <!-- äººå‘˜ç®¡ç† -->
            <div class="section">
                <div class="section-title">äººå‘˜ç®¡ç†</div>
                <div class="input-group">
                    <div class="grid-2">
                        <input type="text" class="input-field" id="newPersonName" placeholder="è¾“å…¥å§“å">
                        <button class="btn btn-primary" onclick="addPerson()">â• æ·»åŠ äººå‘˜</button>
                    </div>
                </div>
                <div class="person-list" id="personList"></div>
                
                <!-- æ¸…é™¤åŠŸèƒ½æŒ‰é’® -->
                <div class="clear-actions">
                    <button class="btn btn-warning btn-small" onclick="clearPersons()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰äººå‘˜</button>
                    <button class="btn btn-warning btn-small" onclick="clearItems()">ğŸ—‘ï¸ æ¸…é™¤å½“å‰æ¸…å•</button>
                    <button class="btn btn-danger btn-small" onclick="clearAll()">âš ï¸ æ¸…é™¤æ‰€æœ‰ä¿¡æ¯</button>
                </div>
            </div>

            <!-- AAåˆ¶æ¨¡å¼ -->
            <div class="section mode-content" id="mode-aa">
                <div class="section-title">AAåˆ¶è¯¦æƒ…</div>
                <div id="aaItemsList"></div>
                <button class="btn btn-primary" onclick="addAAItem()">â• æ·»åŠ æ¶ˆè´¹é¡¹ç›®</button>
            </div>

            <!-- ä¼˜æƒ å…±äº«æ¨¡å¼ -->
            <div class="section mode-content hidden" id="mode-share">
                <div class="section-title">ä¼˜æƒ å…±äº«è®¾ç½®</div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="isDelivery" onchange="toggleDeliveryMode()">
                    <label for="isDelivery">å¤–å–æ¨¡å¼ï¼ˆé¢å¤–è´¹ç”¨å‡åˆ†ï¼‰</label>
                </div>

                <div class="input-group">
                    <label class="input-label">è®¢å•æ€»é‡‘é¢</label>
                    <input type="number" class="input-field" id="shareTotalAmount" placeholder="è¾“å…¥è®¢å•æ€»é‡‘é¢" oninput="calculateShare()">
                </div>

                <div class="input-group">
                    <label class="input-label">ä¼˜æƒ æ€»é‡‘é¢</label>
                    <input type="number" class="input-field" id="shareDiscountAmount" placeholder="è¾“å…¥ä¼˜æƒ é‡‘é¢" oninput="calculateShare()">
                </div>

                <div id="deliveryFees" class="hidden">
                    <div class="input-group">
                        <label class="input-label">é¢å¤–è´¹ç”¨ï¼ˆå‡åˆ†ï¼‰</label>
                        <div id="extraFeesList"></div>
                        <button class="btn btn-secondary btn-small" onclick="addExtraFee()" style="margin-top: 10px;">â• æ·»åŠ é¢å¤–è´¹ç”¨</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">æ¯äººè´­ä¹°é‡‘é¢</label>
                    <div class="amount-input-grid" id="shareAmountInputs"></div>
                </div>
            </div>

            <!-- ä¼˜æƒ å¹³åˆ†æ¨¡å¼ -->
            <div class="section mode-content hidden" id="mode-equal">
                <div class="section-title">ä¼˜æƒ å¹³åˆ†è®¾ç½®</div>
                
                <div class="input-group">
                    <label class="input-label">ä¼˜æƒ æ€»é‡‘é¢</label>
                    <input type="number" class="input-field" id="equalDiscountAmount" placeholder="è¾“å…¥ä¼˜æƒ æ€»é‡‘é¢" oninput="calculateEqual()">
                </div>

                <div class="input-group">
                    <label class="input-label">æ¯äººè´­ä¹°é‡‘é¢</label>
                    <div class="amount-input-grid" id="equalAmountInputs"></div>
                </div>
            </div>

            <!-- ä»£è´­æ¨¡å¼ -->
            <div class="section mode-content hidden" id="mode-purchase">
                <div class="section-title">ä»£è´­è¯¦æƒ…</div>
                <div id="purchaseItemsList"></div>
                <button class="btn btn-primary" onclick="addPurchaseItem()">â• æ·»åŠ ä»£è´­é¡¹ç›®</button>
                
                <div class="input-group" style="margin-top: 20px;">
                    <label class="input-label">é¢å¤–å›ºå®šè´¹ç”¨ï¼ˆè·‘è…¿è´¹ã€æ²¹è´¹ç­‰ï¼‰</label>
                    <div id="purchaseExtraFees"></div>
                    <button class="btn btn-secondary btn-small" onclick="addPurchaseExtraFee()" style="margin-top: 10px;">â• æ·»åŠ é¢å¤–è´¹ç”¨</button>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰æ¨¡å¼ -->
            <div class="section mode-content hidden" id="mode-custom">
                <div class="section-title">è‡ªå®šä¹‰é‡‘é¢</div>
                <div class="input-group">
                    <label class="input-label">ä¸ºæ¯ä¸ªäººè¾“å…¥åº”ä»˜é‡‘é¢</label>
                    <div class="amount-input-grid" id="customAmountInputs"></div>
                </div>
            </div>

            <!-- æ±‡æ€»é¢æ¿ -->
            <div class="summary-panel" id="summaryPanel">
                <div class="summary-title">
                    <span>ğŸ’³ ç»“ç®—æ±‡æ€»</span>
                    <div id="detailToggle" class="hidden" style="display: flex; align-items: center; gap: 10px; font-size: 14px;">
                        <span>æŸ¥çœ‹è¯¦æƒ…</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="showDetailsToggle" onchange="toggleDetails()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div id="summaryContent">
                    <div style="text-align: center; opacity: 0.8;">è¯·å…ˆæ·»åŠ äººå‘˜å’Œæ¶ˆè´¹é¡¹ç›®</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let state = {
            currentMode: 'aa',
            persons: [],
            aaItems: [],
            shareData: {
                totalAmount: 0,
                discountAmount: 0,
                extraFees: [],
                personAmounts: {}
            },
            equalData: {
                discountAmount: 0,
                personAmounts: {}
            },
            purchaseData: {
                items: [],
                extraFees: []
            },
            customData: {},
            showDetails: false
        };

        // åˆå§‹åŒ–
        function init() {
            loadFromLocalStorage();
            renderPersonList();
            renderAAItems();
            renderPurchaseItems();
            renderPurchaseExtraFees();
            initModeInputs();
            updateSummary();
            
            // æ¢å¤æ¨¡å¼é€‰æ‹©
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.mode === state.currentMode) {
                    card.classList.add('active');
                }
            });
            
            // æ˜¾ç¤ºå¯¹åº”æ¨¡å¼å†…å®¹
            document.querySelectorAll('.mode-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById('mode-' + state.currentMode).classList.remove('hidden');
            
            // æ¢å¤å¤–å–æ¨¡å¼
            if (state.shareData.extraFees && state.shareData.extraFees.length > 0) {
                document.getElementById('isDelivery').checked = true;
                document.getElementById('deliveryFees').classList.remove('hidden');
                renderExtraFees();
            }
            
            // æ¢å¤è¾“å…¥å€¼
            if (document.getElementById('shareTotalAmount')) {
                document.getElementById('shareTotalAmount').value = state.shareData.totalAmount || '';
            }
            if (document.getElementById('shareDiscountAmount')) {
                document.getElementById('shareDiscountAmount').value = state.shareData.discountAmount || '';
            }
            if (document.getElementById('equalDiscountAmount')) {
                document.getElementById('equalDiscountAmount').value = state.equalData.discountAmount || '';
            }
        }

        // æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            localStorage.setItem('billSplitState', JSON.stringify(state));
            console.log('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('billSplitState');
            if (saved) {
                try {
                    const loadedState = JSON.parse(saved);
                    // åˆå¹¶çŠ¶æ€ï¼Œä¿æŒé»˜è®¤å€¼
                    state = {
                        ...state,
                        ...loadedState
                    };
                    console.log('æ•°æ®å·²ä»æœ¬åœ°åŠ è½½');
                } catch (e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                }
            }
        }

        // æ¸…é™¤åŠŸèƒ½
        function clearPersons() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰äººå‘˜å—ï¼Ÿè¿™å°†åŒæ—¶æ¸…é™¤æ‰€æœ‰ç›¸å…³æ•°æ®ã€‚')) {
                state.persons = [];
                state.shareData.personAmounts = {};
                state.equalData.personAmounts = {};
                state.customData = {};
                
                // æ¸…é™¤AAåˆ¶ä¸­çš„é€‰äºº
                state.aaItems.forEach(item => {
                    item.selectedPersons = [];
                });
                
                renderPersonList();
                renderAAItems();
                initModeInputs();
                updateSummary();
                saveToLocalStorage();
                showToast('å·²æ¸…é™¤æ‰€æœ‰äººå‘˜', 'success');
            }
        }

        function clearItems() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰æ¨¡å¼çš„æ‰€æœ‰æ¸…å•å—ï¼Ÿ')) {
                switch (state.currentMode) {
                    case 'aa':
                        state.aaItems = [];
                        renderAAItems();
                        break;
                    case 'share':
                        state.shareData.totalAmount = 0;
                        state.shareData.discountAmount = 0;
                        state.shareData.extraFees = [];
                        state.shareData.personAmounts = {};
                        document.getElementById('shareTotalAmount').value = '';
                        document.getElementById('shareDiscountAmount').value = '';
                        document.getElementById('isDelivery').checked = false;
                        document.getElementById('deliveryFees').classList.add('hidden');
                        renderExtraFees();
                        initModeInputs();
                        break;
                    case 'equal':
                        state.equalData.discountAmount = 0;
                        state.equalData.personAmounts = {};
                        document.getElementById('equalDiscountAmount').value = '';
                        initModeInputs();
                        break;
                    case 'purchase':
                        state.purchaseData.items = [];
                        state.purchaseData.extraFees = [];
                        renderPurchaseItems();
                        renderPurchaseExtraFees();
                        break;
                    case 'custom':
                        state.customData = {};
                        initModeInputs();
                        break;
                }
                updateSummary();
                saveToLocalStorage();
                showToast('å·²æ¸…é™¤å½“å‰æ¸…å•', 'success');
            }
        }

        function clearAll() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¿¡æ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                if (confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                    localStorage.removeItem('billSplitState');
                    state = {
                        currentMode: 'aa',
                        persons: [],
                        aaItems: [],
                        shareData: {
                            totalAmount: 0,
                            discountAmount: 0,
                            extraFees: [],
                            personAmounts: {}
                        },
                        equalData: {
                            discountAmount: 0,
                            personAmounts: {}
                        },
                        purchaseData: {
                            items: [],
                            extraFees: []
                        },
                        customData: {},
                        showDetails: false
                    };
                    
                    // é‡æ–°åˆå§‹åŒ–ç•Œé¢
                    init();
                    showToast('å·²æ¸…é™¤æ‰€æœ‰ä¿¡æ¯', 'success');
                }
            }
        }

        // æ¨¡å¼åˆ‡æ¢
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                const mode = this.dataset.mode;
                state.currentMode = mode;
                
                document.querySelectorAll('.mode-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById('mode-' + mode).classList.remove('hidden');
                
                initModeInputs();
                updateSummary();
                saveToLocalStorage();
            });
        });

        // äººå‘˜ç®¡ç†
        function addPerson() {
            const input = document.getElementById('newPersonName');
            const name = input.value.trim();
            
            if (!name) {
                showToast('è¯·è¾“å…¥å§“å', 'warning');
                return;
            }
            
            if (state.persons.some(p => p.name === name)) {
                showToast('è¯¥å§“åå·²å­˜åœ¨', 'warning');
                return;
            }
            
            state.persons.push({
                id: Date.now(),
                name: name
            });
            
            input.value = '';
            renderPersonList();
            initModeInputs();
            updateSummary();
            saveToLocalStorage();
            showToast('æ·»åŠ æˆåŠŸ', 'success');
        }

        function removePerson(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥äººå‘˜å—ï¼Ÿ')) {
                state.persons = state.persons.filter(p => p.id !== id);
                
                // åˆ é™¤ç›¸å…³æ•°æ®
                delete state.shareData.personAmounts[id];
                delete state.equalData.personAmounts[id];
                delete state.customData[id];
                
                // ä»AAé¡¹ç›®ä¸­ç§»é™¤
                state.aaItems.forEach(item => {
                    item.selectedPersons = item.selectedPersons.filter(pid => pid !== id);
                });
                
                renderPersonList();
                renderAAItems();
                initModeInputs();
                updateSummary();
                saveToLocalStorage();
            }
        }

        function renderPersonList() {
            const container = document.getElementById('personList');
            if (state.persons.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">æš‚æ— äººå‘˜ï¼Œè¯·æ·»åŠ </div>';
                return;
            }
            
            container.innerHTML = state.persons.map((person, index) => {
                const badge = index < 9 ? (index + 1) : (index < 35 ? String.fromCharCode(65 + index - 9) : 'â€¢');
                return `
                    <div class="person-item">
                        <div class="person-badge">${badge}</div>
                        <div class="person-name">${person.name}</div>
                        <button class="person-remove" onclick="removePerson(${person.id})">Ã—</button>
                    </div>
                `;
            }).join('');
        }

        // AAåˆ¶æ¨¡å¼
        function addAAItem() {
            const item = {
                id: Date.now(),
                description: '',
                amount: 0,
                selectedPersons: [],
                receipt: null
            };
            
            state.aaItems.push(item);
            renderAAItems();
            saveToLocalStorage();
        }

        function removeAAItem(id) {
            state.aaItems = state.aaItems.filter(item => item.id !== id);
            renderAAItems();
            updateSummary();
            saveToLocalStorage();
        }

        function renderAAItems() {
            const container = document.getElementById('aaItemsList');
            
            if (state.aaItems.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = state.aaItems.map(item => `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-title">æ¶ˆè´¹é¡¹ç›® #${state.aaItems.indexOf(item) + 1}</div>
                        <button class="btn btn-danger btn-small" onclick="removeAAItem(${item.id})">åˆ é™¤</button>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">æ¶ˆè´¹æè¿°</label>
                        <input type="text" class="input-field" value="${item.description}" 
                            oninput="updateAAItem(${item.id}, 'description', this.value)" 
                            placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€æ™šé¤">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">æ¶ˆè´¹é‡‘é¢</label>
                        <input type="number" class="input-field" value="${item.amount || ''}" 
                            oninput="updateAAItem(${item.id}, 'amount', parseFloat(this.value) || 0)" 
                            placeholder="è¾“å…¥é‡‘é¢">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">å‚ä¸äººå‘˜ 
                            <span class="info-badge">é”®ç›˜å¿«æ·é”®ï¼š1-9, A-Z</span>
                        </label>
                        <button class="btn btn-secondary btn-small" onclick="openPersonSelector(${item.id})">
                            é€‰æ‹©å‚ä¸äººå‘˜ (${item.selectedPersons.length}äºº)
                        </button>
                        <div class="selected-persons-display">
                            ${item.selectedPersons.map(pid => {
                                const person = state.persons.find(p => p.id === pid);
                                return person ? `<span class="selected-tag">${person.name}</span>` : '';
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">ä¸Šä¼ å°ç¥¨ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="file-upload ${item.receipt ? 'has-file' : ''}" onclick="document.getElementById('receipt-${item.id}').click()">
                            <input type="file" id="receipt-${item.id}" accept="image/*" 
                                onchange="handleReceiptUpload(${item.id}, this)">
                            ğŸ“· ${item.receipt ? 'å·²ä¸Šä¼ ï¼ˆç‚¹å‡»æŸ¥çœ‹æˆ–æ›´æ¢ï¼‰' : 'ç‚¹å‡»ä¸Šä¼ å°ç¥¨'}
                        </div>
                        ${item.receipt ? `
                            <img src="${item.receipt}" class="receipt-preview" onclick="viewReceipt(${item.id}); event.stopPropagation();" alt="å°ç¥¨é¢„è§ˆ">
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateAAItem(id, field, value) {
            const item = state.aaItems.find(item => item.id === id);
            if (item) {
                item[field] = value;
                updateSummary();
                saveToLocalStorage();
            }
        }

        function handleReceiptUpload(id, input) {
            const item = state.aaItems.find(item => item.id === id);
            if (item && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    item.receipt = e.target.result;
                    renderAAItems();
                    saveToLocalStorage();
                    showToast('å°ç¥¨ä¸Šä¼ æˆåŠŸ', 'success');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function viewReceipt(itemId) {
            const item = state.aaItems.find(i => i.id === itemId);
            if (!item || !item.receipt) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>å°ç¥¨æŸ¥çœ‹</span>
                            <button class="btn btn-secondary btn-small" onclick="this.closest('.modal').remove()">å…³é—­</button>
                        </div>
                    </div>
                    <img src="${item.receipt}" class="modal-image" alt="å°ç¥¨">
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // é€‰äººæ¨¡å¼
        let currentSelectingItemId = null;
        let selectedPersonsTemp = [];

        function openPersonSelector(itemId) {
            if (state.persons.length === 0) {
                showToast('è¯·å…ˆæ·»åŠ äººå‘˜', 'warning');
                return;
            }
            
            currentSelectingItemId = itemId;
            const item = state.aaItems.find(i => i.id === itemId);
            selectedPersonsTemp = [...item.selectedPersons];
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'personSelectorModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">é€‰æ‹©å‚ä¸äººå‘˜</div>
                    <div style="margin-bottom: 15px; color: var(--text-secondary); font-size: 13px;">
                        ğŸ’¡ ä½¿ç”¨é”®ç›˜å¿«æ·é”®ï¼š1-9é€‰æ‹©å‰9äººï¼ŒA-Zé€‰æ‹©ç¬¬10-35äººï¼Œæˆ–ç‚¹å‡»é€‰æ‹©
                    </div>
                    <div class="person-list" id="modalPersonList">
                        ${state.persons.map((person, index) => {
                            const badge = index < 9 ? (index + 1) : (index < 35 ? String.fromCharCode(65 + index - 9) : 'â€¢');
                            const selected = selectedPersonsTemp.includes(person.id);
                            return `
                                <div class="person-item ${selected ? 'selected' : ''}" 
                                    onclick="togglePersonSelection(${person.id})" 
                                    data-person-id="${person.id}">
                                    <div class="person-badge">${badge}</div>
                                    <div class="person-name">${person.name}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="flex: 1;" onclick="confirmPersonSelection()">ç¡®è®¤</button>
                        <button class="btn btn-secondary" onclick="closePersonSelector()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.addEventListener('keydown', handlePersonSelectionKeyboard);
        }

        function togglePersonSelection(personId) {
            const index = selectedPersonsTemp.indexOf(personId);
            if (index > -1) {
                selectedPersonsTemp.splice(index, 1);
            } else {
                selectedPersonsTemp.push(personId);
            }
            
            // æ›´æ–°æ˜¾ç¤º
            const personItems = document.querySelectorAll('#modalPersonList .person-item');
            personItems.forEach(item => {
                const pid = parseInt(item.dataset.personId);
                if (pid === personId) {
                    item.classList.toggle('selected');
                }
            });
        }

        function handlePersonSelectionKeyboard(e) {
            // 1-9
            if (e.key >= '1' && e.key <= '9') {
                const index = parseInt(e.key) - 1;
                if (index < state.persons.length) {
                    togglePersonSelection(state.persons[index].id);
                }
            }
            // A-Z
            else if (e.key.toUpperCase() >= 'A' && e.key.toUpperCase() <= 'Z') {
                const index = e.key.toUpperCase().charCodeAt(0) - 65 + 9;
                if (index < state.persons.length) {
                    togglePersonSelection(state.persons[index].id);
                }
            }
            // Enterç¡®è®¤
            else if (e.key === 'Enter') {
                confirmPersonSelection();
            }
            // Escapeå–æ¶ˆ
            else if (e.key === 'Escape') {
                closePersonSelector();
            }
        }

        function confirmPersonSelection() {
            const item = state.aaItems.find(i => i.id === currentSelectingItemId);
            if (item) {
                item.selectedPersons = [...selectedPersonsTemp];
                renderAAItems();
                updateSummary();
                saveToLocalStorage();
            }
            closePersonSelector();
        }

        function closePersonSelector() {
            const modal = document.getElementById('personSelectorModal');
            if (modal) {
                modal.remove();
            }
            document.removeEventListener('keydown', handlePersonSelectionKeyboard);
            currentSelectingItemId = null;
            selectedPersonsTemp = [];
        }

        // ä¼˜æƒ å…±äº«æ¨¡å¼
        function toggleDeliveryMode() {
            const isDelivery = document.getElementById('isDelivery').checked;
            const deliveryFees = document.getElementById('deliveryFees');
            
            if (isDelivery) {
                deliveryFees.classList.remove('hidden');
                if (state.shareData.extraFees.length === 0) {
                    addExtraFee();
                }
            } else {
                deliveryFees.classList.add('hidden');
                state.shareData.extraFees = [];
            }
            
            renderExtraFees();
            calculateShare();
            saveToLocalStorage();
        }

        function addExtraFee() {
            state.shareData.extraFees.push({
                id: Date.now(),
                name: '',
                amount: 0
            });
            renderExtraFees();
            saveToLocalStorage();
        }

        function renderExtraFees() {
            const container = document.getElementById('extraFeesList');
            container.innerHTML = state.shareData.extraFees.map(fee => `
                <div class="extra-fee-item">
                    <input type="text" class="input-field" value="${fee.name}" 
                        placeholder="è´¹ç”¨åç§°ï¼ˆå¦‚é…é€è´¹ï¼‰" 
                        oninput="updateExtraFee(${fee.id}, 'name', this.value)">
                    <input type="number" class="input-field" value="${fee.amount || ''}" 
                        placeholder="é‡‘é¢" 
                        oninput="updateExtraFee(${fee.id}, 'amount', parseFloat(this.value) || 0)">
                    <button class="btn btn-danger btn-small" onclick="removeExtraFee(${fee.id})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        function updateExtraFee(id, field, value) {
            const fee = state.shareData.extraFees.find(f => f.id === id);
            if (fee) {
                fee[field] = value;
                calculateShare();
                saveToLocalStorage();
            }
        }

        function removeExtraFee(id) {
            state.shareData.extraFees = state.shareData.extraFees.filter(f => f.id !== id);
            renderExtraFees();
            calculateShare();
            saveToLocalStorage();
        }

        function initModeInputs() {
            // ä¼˜æƒ å…±äº«æ¨¡å¼
            const shareContainer = document.getElementById('shareAmountInputs');
            shareContainer.innerHTML = state.persons.map(person => `
                <div class="amount-input-item">
                    <label>${person.name}</label>
                    <input type="number" class="input-field" 
                        value="${state.shareData.personAmounts[person.id] || ''}" 
                        placeholder="è¾“å…¥è´­ä¹°é‡‘é¢" 
                        oninput="updateShareAmount(${person.id}, parseFloat(this.value) || 0)">
                </div>
            `).join('');
            
            // ä¼˜æƒ å¹³åˆ†æ¨¡å¼
            const equalContainer = document.getElementById('equalAmountInputs');
            equalContainer.innerHTML = state.persons.map(person => `
                <div class="amount-input-item">
                    <label>${person.name}</label>
                    <input type="number" class="input-field" 
                        value="${state.equalData.personAmounts[person.id] || ''}" 
                        placeholder="è¾“å…¥è´­ä¹°é‡‘é¢" 
                        oninput="updateEqualAmount(${person.id}, parseFloat(this.value) || 0)">
                </div>
            `).join('');
            
            // è‡ªå®šä¹‰æ¨¡å¼
            const customContainer = document.getElementById('customAmountInputs');
            customContainer.innerHTML = state.persons.map(person => `
                <div class="amount-input-item">
                    <label>${person.name}</label>
                    <input type="number" class="input-field" 
                        value="${state.customData[person.id] || ''}" 
                        placeholder="è¾“å…¥åº”ä»˜é‡‘é¢" 
                        oninput="updateCustomAmount(${person.id}, parseFloat(this.value) || 0)">
                </div>
            `).join('');
        }

        function updateShareAmount(personId, amount) {
            state.shareData.personAmounts[personId] = amount;
            calculateShare();
            saveToLocalStorage();
        }

        function calculateShare() {
            state.shareData.totalAmount = parseFloat(document.getElementById('shareTotalAmount')?.value) || 0;
            state.shareData.discountAmount = parseFloat(document.getElementById('shareDiscountAmount')?.value) || 0;
            
            updateSummary();
            saveToLocalStorage();
        }

        // ä¼˜æƒ å¹³åˆ†æ¨¡å¼
        function updateEqualAmount(personId, amount) {
            state.equalData.personAmounts[personId] = amount;
            calculateEqual();
            saveToLocalStorage();
        }

        function calculateEqual() {
            state.equalData.discountAmount = parseFloat(document.getElementById('equalDiscountAmount')?.value) || 0;
            updateSummary();
            saveToLocalStorage();
        }

        // ä»£è´­æ¨¡å¼
        function addPurchaseItem() {
            const item = {
                id: Date.now(),
                buyerName: '',
                description: '',
                amount: 0
            };
            
            state.purchaseData.items.push(item);
            renderPurchaseItems();
            saveToLocalStorage();
        }

        function removePurchaseItem(id) {
            state.purchaseData.items = state.purchaseData.items.filter(item => item.id !== id);
            renderPurchaseItems();
            updateSummary();
            saveToLocalStorage();
        }

        function renderPurchaseItems() {
            const container = document.getElementById('purchaseItemsList');
            
            if (state.purchaseData.items.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = state.purchaseData.items.map(item => `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-title">ä»£è´­é¡¹ç›® #${state.purchaseData.items.indexOf(item) + 1}</div>
                        <button class="btn btn-danger btn-small" onclick="removePurchaseItem(${item.id})">åˆ é™¤</button>
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">ä¹°å®¶å§“å</label>
                            <input type="text" class="input-field" value="${item.buyerName}" 
                                oninput="updatePurchaseItem(${item.id}, 'buyerName', this.value)" 
                                placeholder="è¾“å…¥ä¹°å®¶å§“å">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">å•†å“é‡‘é¢</label>
                            <input type="number" class="input-field" value="${item.amount || ''}" 
                                oninput="updatePurchaseItem(${item.id}, 'amount', parseFloat(this.value) || 0)" 
                                placeholder="è¾“å…¥é‡‘é¢">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">å•†å“æè¿°</label>
                        <input type="text" class="input-field" value="${item.description}" 
                            oninput="updatePurchaseItem(${item.id}, 'description', this.value)" 
                            placeholder="å•†å“æè¿°">
                    </div>
                </div>
            `).join('');
        }

        function updatePurchaseItem(id, field, value) {
            const item = state.purchaseData.items.find(item => item.id === id);
            if (item) {
                item[field] = value;
                updateSummary();
                saveToLocalStorage();
            }
        }

        function addPurchaseExtraFee() {
            state.purchaseData.extraFees.push({
                id: Date.now(),
                name: '',
                amount: 0
            });
            renderPurchaseExtraFees();
            saveToLocalStorage();
        }

        function renderPurchaseExtraFees() {
            const container = document.getElementById('purchaseExtraFees');
            container.innerHTML = state.purchaseData.extraFees.map(fee => `
                <div class="extra-fee-item">
                    <input type="text" class="input-field" value="${fee.name}" 
                        placeholder="è´¹ç”¨åç§°ï¼ˆå¦‚è·‘è…¿è´¹ï¼‰" 
                        oninput="updatePurchaseExtraFee(${fee.id}, 'name', this.value)">
                    <input type="number" class="input-field" value="${fee.amount || ''}" 
                        placeholder="é‡‘é¢" 
                        oninput="updatePurchaseExtraFee(${fee.id}, 'amount', parseFloat(this.value) || 0)">
                    <button class="btn btn-danger btn-small" onclick="removePurchaseExtraFee(${fee.id})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        function updatePurchaseExtraFee(id, field, value) {
            const fee = state.purchaseData.extraFees.find(f => f.id === id);
            if (fee) {
                fee[field] = value;
                updateSummary();
                saveToLocalStorage();
            }
        }

        function removePurchaseExtraFee(id) {
            state.purchaseData.extraFees = state.purchaseData.extraFees.filter(f => f.id !== id);
            renderPurchaseExtraFees();
            updateSummary();
            saveToLocalStorage();
        }

        // è‡ªå®šä¹‰æ¨¡å¼
        function updateCustomAmount(personId, amount) {
            state.customData[personId] = amount;
            updateSummary();
            saveToLocalStorage();
        }

        // è¯¦æƒ…åˆ‡æ¢
        function toggleDetails() {
            state.showDetails = document.getElementById('showDetailsToggle').checked;
            updateSummary();
            saveToLocalStorage();
        }

        // æ±‡æ€»è®¡ç®—
        function updateSummary() {
            const container = document.getElementById('summaryContent');
            const detailToggle = document.getElementById('detailToggle');
            
            if (state.persons.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.8;">è¯·å…ˆæ·»åŠ äººå‘˜</div>';
                detailToggle.classList.add('hidden');
                return;
            }
            
            let summary = {};
            let details = {};
            
            switch (state.currentMode) {
                case 'aa':
                    const aaResult = calculateAASummary();
                    summary = aaResult.summary;
                    details = aaResult.details;
                    detailToggle.classList.remove('hidden');
                    document.getElementById('showDetailsToggle').checked = state.showDetails;
                    break;
                case 'share':
                    summary = calculateShareSummary();
                    detailToggle.classList.add('hidden');
                    break;
                case 'equal':
                    summary = calculateEqualSummary();
                    detailToggle.classList.add('hidden');
                    break;
                case 'purchase':
                    summary = calculatePurchaseSummary();
                    detailToggle.classList.add('hidden');
                    break;
                case 'custom':
                    summary = calculateCustomSummary();
                    detailToggle.classList.add('hidden');
                    break;
            }
            
            container.innerHTML = Object.entries(summary).map(([personId, amount]) => {
                const person = state.persons.find(p => p.id == personId);
                if (!person && state.currentMode !== 'purchase') return '';
                
                const personName = person ? person.name : personId;
                const personDetails = details && details[personId] ? details[personId] : [];
                
                return `
                    <div class="summary-item">
                        <div class="summary-item-header">
                            <div class="summary-name">${personName}</div>
                            <div class="summary-amount">Â¥${amount.toFixed(2)}</div>
                        </div>
                        ${state.showDetails && personDetails.length > 0 ? `
                            <div class="summary-details">
                                ${personDetails.map(detail => `
                                    <div class="summary-detail-item">
                                        <span>${detail.description || 'æœªå‘½åé¡¹ç›®'}</span>
                                        <span>Â¥${detail.amount.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('') || '<div style="text-align: center; opacity: 0.8;">æš‚æ— æ•°æ®</div>';
        }

        function calculateAASummary() {
            const summary = {};
            const details = {};
            
            state.persons.forEach(person => {
                summary[person.id] = 0;
                details[person.id] = [];
            });
            
            state.aaItems.forEach(item => {
                if (item.selectedPersons.length > 0 && item.amount > 0) {
                    const perPerson = item.amount / item.selectedPersons.length;
                    item.selectedPersons.forEach(personId => {
                        if (summary[personId] !== undefined) {
                            summary[personId] += perPerson;
                            details[personId].push({
                                description: item.description,
                                amount: perPerson
                            });
                        }
                    });
                }
            });
            
            return { summary, details };
        }

        function calculateShareSummary() {
            const summary = {};
            state.persons.forEach(person => {
                summary[person.id] = 0;
            });
            
            // è®¡ç®—æ¯äººè´­ä¹°çš„åŸä»·æ€»å’Œ
            let totalPersonAmount = 0;
            Object.values(state.shareData.personAmounts).forEach(amount => {
                totalPersonAmount += amount;
            });
            
            if (totalPersonAmount === 0) return summary;
            
            // è®¡ç®—é¢å¤–è´¹ç”¨æ€»å’Œ
            const totalExtraFees = state.shareData.extraFees.reduce((sum, fee) => sum + fee.amount, 0);
            const extraFeePerPerson = totalExtraFees / state.persons.length;
            
            // å®é™…æ”¯ä»˜é‡‘é¢ï¼ˆåŸä»·-ä¼˜æƒ +é¢å¤–è´¹ç”¨ï¼‰
            const actualTotal = totalPersonAmount - state.shareData.discountAmount + totalExtraFees;
            
            state.persons.forEach(person => {
                const personAmount = state.shareData.personAmounts[person.id] || 0;
                // æŒ‰æ¯”ä¾‹åˆ†æ‘Šä¼˜æƒ 
                const discountShare = (personAmount / totalPersonAmount) * state.shareData.discountAmount;
                // æœ€ç»ˆé‡‘é¢ = åŸä»· - åˆ†æ‘Šçš„ä¼˜æƒ  + å‡åˆ†çš„é¢å¤–è´¹ç”¨
                summary[person.id] = personAmount - discountShare + extraFeePerPerson;
            });
            
            return summary;
        }

        function calculateEqualSummary() {
            const summary = {};
            
            const participantCount = Object.values(state.equalData.personAmounts).filter(amount => amount > 0).length;
            if (participantCount === 0) return summary;
            
            const discountPerPerson = state.equalData.discountAmount / participantCount;
            
            state.persons.forEach(person => {
                const personAmount = state.equalData.personAmounts[person.id] || 0;
                if (personAmount > 0) {
                    summary[person.id] = personAmount - discountPerPerson;
                } else {
                    summary[person.id] = 0;
                }
            });
            
            return summary;
        }

        function calculatePurchaseSummary() {
            const summary = {};
            
            // æŒ‰ä¹°å®¶å§“ååˆ†ç»„
            const buyerGroups = {};
            state.purchaseData.items.forEach(item => {
                if (!item.buyerName) return;
                if (!buyerGroups[item.buyerName]) {
                    buyerGroups[item.buyerName] = 0;
                }
                buyerGroups[item.buyerName] += item.amount;
            });
            
            // è®¡ç®—æ€»é¢å¤–è´¹ç”¨
            const totalExtraFees = state.purchaseData.extraFees.reduce((sum, fee) => sum + fee.amount, 0);
            const buyerCount = Object.keys(buyerGroups).length;
            const extraFeePerBuyer = buyerCount > 0 ? totalExtraFees / buyerCount : 0;
            
            // ä¸ºæ¯ä¸ªä¹°å®¶è®¡ç®—æ€»é¢
            Object.entries(buyerGroups).forEach(([buyerName, amount]) => {
                // ä½¿ç”¨ä¹°å®¶å§“åä½œä¸ºkeyï¼Œå› ä¸ºä¸ä¸€å®šåœ¨personsåˆ—è¡¨ä¸­
                summary[buyerName] = amount + extraFeePerBuyer;
            });
            
            return summary;
        }

        function calculateCustomSummary() {
            const summary = {};
            state.persons.forEach(person => {
                summary[person.id] = state.customData[person.id] || 0;
            });
            return summary;
        }

        // Toastæç¤º
        function showToast(message, type = 'info') {
            const colors = {
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444',
                info: '#6366f1'
            };
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeft = `4px solid ${colors[type]}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // é”®ç›˜äº‹ä»¶ - æ·»åŠ äººå‘˜
        document.getElementById('newPersonName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addPerson();
            }
        });

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>